{% extends "base.html" %}
{% block title %}Dashboard - DockerMate{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900" x-data="dashboardComponent()" x-init="init()">
    {% include 'components/navbar.html' %}

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-white">Dashboard</h2>
            <p class="mt-1 text-slate-400">Platform overview</p>
            <p class="text-xs text-slate-600 mt-1" x-text="'Last updated: ' + lastUpdated"></p>
        </div>

        <!-- =====================================================================
             TOP ROW  ‚Äî  Health card  |  Containers card  |  Hardware card
             ===================================================================== -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

            <!-- Health card (replaces old Capacity card) -->
            <div class="bg-slate-800 p-6 rounded-lg border"
                 :class="health.status === 'unhealthy' ? 'border-red-600' :
                         health.status === 'warning'   ? 'border-yellow-500' :
                                                         'border-slate-700'">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-slate-400 text-sm">Health</p>
                    <!-- status badge -->
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full"
                          :class="health.status === 'unhealthy' ? 'bg-red-900 text-red-300' :
                                  health.status === 'warning'   ? 'bg-yellow-900 text-yellow-300' :
                                                                  'bg-green-900 text-green-300'"
                          x-text="health.status.charAt(0).toUpperCase() + health.status.slice(1)"></span>
                </div>

                <!-- capacity bar (always shown) -->
                <div class="mb-3">
                    <div class="flex justify-between text-xs text-slate-500 mb-1">
                        <span>Capacity</span>
                        <span x-text="stats.totalContainers + ' / ' + hardware.max_containers"></span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all duration-300"
                             :class="stats.capacityPercent > 80 ? 'bg-red-500' :
                                     stats.capacityPercent > 60 ? 'bg-yellow-500' : 'bg-green-500'"
                             :style="'width: ' + stats.capacityPercent + '%'"></div>
                    </div>
                </div>

                <!-- checks row: docker + db -->
                <div class="flex gap-4 text-xs mb-3">
                    <span class="flex items-center gap-1">
                        <span :class="health.checks.docker === 'ok' ? 'text-green-400' : 'text-red-400'">‚óè</span>
                        <span class="text-slate-400">Docker</span>
                    </span>
                    <span class="flex items-center gap-1">
                        <span :class="health.checks.database === 'ok' ? 'text-green-400' : 'text-red-400'">‚óè</span>
                        <span class="text-slate-400">Database</span>
                    </span>
                </div>

                <!-- warnings list -->
                <div x-show="health.warnings.length > 0" class="border-t border-slate-700 pt-2 mt-1">
                    <template x-for="w in health.warnings" :key="w">
                        <p class="text-xs text-yellow-300 flex items-start gap-1 mb-1">
                            <span class="mt-0.5">‚ö†</span>
                            <span x-text="w"></span>
                        </p>
                    </template>
                    <a href="/health" class="text-xs text-blue-400 hover:underline mt-1 inline-block">View details ‚Üí</a>
                </div>

                <!-- all-clear when no warnings -->
                <div x-show="health.warnings.length === 0 && health.status === 'healthy'"
                     class="text-xs text-green-400 border-t border-slate-700 pt-2 mt-1">
                    All checks passing
                </div>
            </div>

            <!-- Containers card -->
            <div class="bg-slate-800 p-6 rounded-lg border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Containers</p>
                        <p class="text-3xl font-bold text-white mt-1" x-text="stats.totalContainers"></p>
                        <p class="text-sm mt-2">
                            <span class="text-green-400" x-text="stats.runningContainers + ' running'"></span>
                            <span class="text-slate-500"> / </span>
                            <span class="text-slate-400" x-text="stats.stoppedContainers + ' stopped'"></span>
                        </p>
                    </div>
                    <div class="text-blue-400 text-3xl">üì¶</div>
                </div>
            </div>

            <!-- Hardware card -->
            <div class="bg-slate-800 p-6 rounded-lg border border-slate-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Hardware Profile</p>
                        <p class="text-xl font-bold text-white mt-1" x-text="hardware.profile_name || 'Loading...'"></p>
                        <p class="text-sm mt-2 text-slate-400">
                            <span x-text="hardware.cpu_count + ' CPU'"></span> |
                            <span x-text="hardware.total_memory_gb + ' GB RAM'"></span>
                        </p>
                    </div>
                    <div class="text-purple-400 text-3xl">üíª</div>
                </div>
            </div>
        </div>

        <!-- =====================================================================
             PLATFORM OVERVIEW  ‚Äî  Environments  |  Images  |  Networks
             ===================================================================== -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

            <!-- Environment Distribution -->
            <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
                <h3 class="text-base font-semibold text-white mb-3">Environments</h3>
                <div x-show="stats.byEnvironment.length === 0" class="text-slate-500 text-sm">
                    No containers yet
                </div>
                <div x-show="stats.byEnvironment.length > 0" class="space-y-2">
                    <template x-for="env in stats.byEnvironment" :key="env.name">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-slate-300" x-text="env.name"></span>
                            <span class="text-sm font-semibold text-white bg-slate-700 px-2 py-0.5 rounded" x-text="env.count"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Images Summary -->
            <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
                <h3 class="text-base font-semibold text-white mb-3">Images</h3>
                <div class="flex items-end justify-between mb-3">
                    <div>
                        <p class="text-3xl font-bold text-white" x-text="images.count"></p>
                        <p class="text-xs text-slate-500 mt-0.5" x-text="'Total size: ' + images.totalSizeHuman"></p>
                    </div>
                    <div class="text-purple-400 text-2xl">üñºÔ∏è</div>
                </div>
                <!-- top 3 images by size -->
                <div x-show="images.top.length > 0" class="space-y-1 border-t border-slate-700 pt-2">
                    <p class="text-xs text-slate-500 mb-1">Largest</p>
                    <template x-for="img in images.top" :key="img.name">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-slate-300 truncate mr-2" x-text="img.name"></span>
                            <span class="text-xs text-slate-500 whitespace-nowrap" x-text="img.size"></span>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Networks Summary -->
            <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
                <h3 class="text-base font-semibold text-white mb-3">Networks</h3>
                <div class="flex items-end justify-between mb-3">
                    <div>
                        <p class="text-3xl font-bold text-white" x-text="networks.count"></p>
                        <p class="text-xs text-slate-500 mt-0.5">Active networks</p>
                    </div>
                    <div class="text-teal-400 text-2xl">üåê</div>
                </div>
                <!-- network list -->
                <div x-show="networks.list.length > 0" class="space-y-1 border-t border-slate-700 pt-2">
                    <template x-for="net in networks.list" :key="net.name">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-slate-300" x-text="net.name"></span>
                            <span class="text-xs text-slate-600" x-text="net.driver"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>

    </main>
</div>

<script>
// ---------------------------------------------------------------------------
// Utility: format bytes ‚Üí human-readable string
// ---------------------------------------------------------------------------
function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    const k = 1024;
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + units[i];
}

// ---------------------------------------------------------------------------
// Dashboard Alpine.js component
// ---------------------------------------------------------------------------
function dashboardComponent() {
    return {
        // --- state ---
        stats: {
            totalContainers: 0,
            runningContainers: 0,
            stoppedContainers: 0,
            capacityPercent: 0,
            byEnvironment: []
        },
        hardware: {
            profile_name: 'Loading...',
            cpu_count: 0,
            total_memory_gb: 0,
            max_containers: 0
        },
        health: {
            status: 'healthy',
            checks: { docker: 'ok', database: 'ok' },
            warnings: []
        },
        images: {
            count: 0,
            totalSizeHuman: '0 B',
            top: []          // [{name, size}] top 3 by size
        },
        networks: {
            count: 0,
            list: []         // [{name, driver}]
        },
        lastUpdated: 'Never',
        loading: false,
        pollInterval: null,

        // --- lifecycle ---
        async init() {
            await this.loadAll();
            this.pollInterval = setInterval(() => this.loadAll(), 10000);
        },

        destroy() {
            if (this.pollInterval) clearInterval(this.pollInterval);
        },

        // --- fetch everything in parallel ---
        async loadAll() {
            this.loading = true;
            try {
                await Promise.all([
                    this.loadHardware(),
                    this.loadHealth(),
                    this.loadContainers(),
                    this.loadImages(),
                    this.loadNetworks()
                ]);
                this.lastUpdated = new Date().toLocaleTimeString();
            } catch (e) {
                console.error('Dashboard load error:', e);
            } finally {
                this.loading = false;
            }
        },

        // --- individual loaders ---
        async loadHardware() {
            try {
                const r = await fetch('/api/system/hardware');
                if (!r.ok) return;
                const d = await r.json();
                if (d.success) this.hardware = d.data;
            } catch (e) { console.error('loadHardware:', e); }
        },

        async loadHealth() {
            try {
                const r = await fetch('/api/system/health');
                if (!r.ok) return;
                const d = await r.json();
                if (d.success) {
                    this.health.status   = d.status;
                    this.health.checks   = d.checks;
                    this.health.warnings = d.warnings || [];
                }
            } catch (e) { console.error('loadHealth:', e); }
        },

        async loadContainers() {
            try {
                const r = await fetch('/api/containers?all=true&show_all=true');
                if (!r.ok) return;
                const d = await r.json();
                if (!d.success) return;
                const containers = d.data;

                this.stats.totalContainers  = containers.length;
                this.stats.runningContainers = containers.filter(c => c.state === 'running').length;
                this.stats.stoppedContainers = containers.filter(c => c.state !== 'running').length;

                const max = this.hardware.max_containers || 100;
                this.stats.capacityPercent = Math.min(100, Math.round((containers.length / max) * 100));

                // group by environment
                const groups = {};
                containers.forEach(c => {
                    const env = c.environment || 'UNTAGGED';
                    groups[env] = (groups[env] || 0) + 1;
                });
                this.stats.byEnvironment = Object.entries(groups)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count);
            } catch (e) { console.error('loadContainers:', e); }
        },

        async loadImages() {
            try {
                const r = await fetch('/api/images');
                if (!r.ok) return;
                const d = await r.json();
                if (!d.success) return;

                const imgs = d.data;
                this.images.count = imgs.length;

                // total size
                const totalBytes = imgs.reduce((sum, i) => sum + (i.size_bytes || 0), 0);
                this.images.totalSizeHuman = formatBytes(totalBytes);

                // top 3 by size
                this.images.top = imgs
                    .slice()
                    .sort((a, b) => (b.size_bytes || 0) - (a.size_bytes || 0))
                    .slice(0, 3)
                    .map(i => ({
                        name: (i.repository || '<none>') + ':' + (i.tag || '<none>'),
                        size: formatBytes(i.size_bytes)
                    }));
            } catch (e) { console.error('loadImages:', e); }
        },

        async loadNetworks() {
            try {
                const r = await fetch('/api/system/networks');
                if (!r.ok) return;
                const d = await r.json();
                if (!d.success) return;

                this.networks.count = d.count;
                this.networks.list  = d.data;
            } catch (e) { console.error('loadNetworks:', e); }
        }
    };
}
</script>
{% endblock %}
