{% extends "base.html" %}
{% block title %}Networks - DockerMate{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900" x-data="networksComponent()" x-init="init()">
    {% include 'components/navbar.html' %}

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-white">Networks</h2>
                <p class="text-slate-400 mt-1">Manage Docker networks and IP address allocation</p>
            </div>
            <button @click="showCreateModal = true"
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition">
                + Create Network
            </button>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <p class="text-slate-400 text-sm">Total Networks</p>
                <p class="text-2xl font-bold text-white mt-1" x-text="networks.length"></p>
            </div>
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <p class="text-slate-400 text-sm">Managed</p>
                <p class="text-2xl font-bold text-white mt-1" x-text="managedCount"></p>
            </div>
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <p class="text-slate-400 text-sm">Active Containers</p>
                <p class="text-2xl font-bold text-white mt-1" x-text="totalContainers"></p>
            </div>
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <p class="text-slate-400 text-sm">Oversized</p>
                <p class="text-2xl font-bold mt-1" :class="oversizedCount > 0 ? 'text-yellow-400' : 'text-white'" x-text="oversizedCount"></p>
            </div>
        </div>

        <!-- Loading -->
        <div x-show="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            <p class="text-slate-400 mt-4">Loading networks...</p>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && networks.length === 0" class="bg-slate-800 rounded-lg border border-slate-700 p-12 text-center">
            <div class="text-6xl mb-4">üåê</div>
            <h3 class="text-2xl font-semibold text-white mb-2">No Networks</h3>
            <p class="text-slate-400 mb-4">Create your first Docker network to connect containers</p>
            <button @click="showCreateModal = true"
                    class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition">
                + Create Network
            </button>
        </div>

        <!-- Network List -->
        <div x-show="!loading && networks.length > 0" class="space-y-4">
            <template x-for="network in networks" :key="network.network_id">
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-5">
                    <!-- Network Header Row -->
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 flex-wrap">
                                <h3 class="text-lg font-semibold text-white font-mono" x-text="network.name"></h3>
                                <!-- Managed badge -->
                                <span x-show="network.managed"
                                      class="px-2 py-0.5 bg-green-900 text-green-300 rounded text-xs font-medium">
                                    Managed
                                </span>
                                <!-- Default network badge (bridge/host/none) -->
                                <span x-show="['bridge','host','none'].includes(network.name)"
                                      class="px-2 py-0.5 bg-slate-600 text-slate-300 rounded text-xs font-medium">
                                    Default
                                </span>
                                <!-- Oversized warning -->
                                <span x-show="network.oversized"
                                      class="px-2 py-0.5 bg-yellow-900 text-yellow-300 rounded text-xs font-medium">
                                    ‚ö† Oversized
                                </span>
                            </div>
                            <!-- Meta line -->
                            <div class="mt-2 flex items-center gap-4 flex-wrap text-sm text-slate-400">
                                <span><span class="text-slate-500">Driver:</span> <span x-text="network.driver"></span></span>
                                <span x-show="network.subnet"><span class="text-slate-500">Subnet:</span> <span class="font-mono" x-text="network.subnet"></span></span>
                                <span x-show="network.gateway"><span class="text-slate-500">Gateway:</span> <span class="font-mono" x-text="network.gateway"></span></span>
                                <span><span class="text-slate-500">Containers:</span> <span x-text="network.container_count"></span></span>
                            </div>
                            <!-- Purpose -->
                            <p x-show="network.purpose" class="mt-1 text-slate-500 text-sm italic" x-text="network.purpose"></p>
                        </div>

                        <!-- Actions -->
                        <div class="flex items-center gap-2 ml-4">
                            <button @click="selectNetwork(network)"
                                    class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-sm transition">
                                Details
                            </button>
                            <button x-show="!['bridge','host','none'].includes(network.name) && !network.name.toLowerCase().includes('dockermate')"
                                    @click="confirmDelete(network)"
                                    class="px-3 py-1.5 bg-red-900 hover:bg-red-800 text-red-300 rounded text-sm transition">
                                Delete
                            </button>
                        </div>
                    </div>

                    <!-- Inline container list (collapsed by default, shown when selected) -->
                    <div x-show="selectedNetwork && selectedNetwork.network_id === network.network_id && selectedNetwork.containers"
                         class="mt-4 pt-4 border-t border-slate-700">
                        <h4 class="text-sm font-medium text-slate-300 mb-2">Connected Containers</h4>
                        <!-- Has containers -->
                        <div x-show="selectedNetwork.containers.length > 0" class="space-y-1">
                            <template x-for="c in selectedNetwork.containers" :key="c.container_id">
                                <div class="flex items-center gap-3 bg-slate-700 rounded px-3 py-1.5">
                                    <span class="text-slate-200 text-sm font-mono" x-text="c.name"></span>
                                    <span class="text-slate-500 text-xs font-mono" x-text="c.ipv4_address"></span>
                                </div>
                            </template>
                        </div>
                        <!-- No containers -->
                        <p x-show="selectedNetwork.containers.length === 0" class="text-slate-500 text-sm italic">
                            No containers connected
                        </p>
                    </div>
                </div>
            </template>
        </div>

        <!-- ============================================================
             CREATE NETWORK MODAL
             ============================================================ -->
        <div x-show="showCreateModal"
             class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
            <div class="bg-slate-800 border border-slate-700 rounded-lg w-full max-w-lg mx-4 p-6 shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-white">Create Network</h3>
                    <button @click="showCreateModal = false" class="text-slate-400 hover:text-white text-xl">&times;</button>
                </div>

                <!-- Recommendation banner -->
                <div x-show="recommendation" class="mb-4 bg-slate-700 rounded p-3">
                    <p class="text-slate-300 text-sm font-medium mb-2">Recommended for <span x-text="recommendation ? recommendation.profile : ''"></span></p>
                    <div class="flex gap-3">
                        <button @click="applyRecommendation('small')"
                                class="flex-1 px-3 py-1.5 bg-slate-600 hover:bg-slate-500 rounded text-sm text-slate-200 transition">
                            Small (<span x-text="recommendation ? recommendation.small_hosts : 0"></span> hosts)
                            <span class="text-slate-400 font-mono" x-text="recommendation ? recommendation.small.split('/').pop() : ''"></span>
                        </button>
                        <button @click="applyRecommendation('large')"
                                class="flex-1 px-3 py-1.5 bg-slate-600 hover:bg-slate-500 rounded text-sm text-slate-200 transition">
                            Large (<span x-text="recommendation ? recommendation.large_hosts : 0"></span> hosts)
                            <span class="text-slate-400 font-mono" x-text="recommendation ? recommendation.large.split('/').pop() : ''"></span>
                        </button>
                    </div>
                </div>

                <!-- Form -->
                <div class="space-y-4">
                    <!-- Name -->
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">Network Name <span class="text-red-400">*</span></label>
                        <input x-model="createForm.name"
                               type="text" placeholder="e.g. app-backend"
                               class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500">
                    </div>

                    <!-- Driver -->
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">Driver</label>
                        <select x-model="createForm.driver"
                                class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                            <option value="bridge">bridge (default ‚Äî isolated network)</option>
                            <option value="host">host (shares host networking)</option>
                            <option value="none">none (no networking)</option>
                        </select>
                    </div>

                    <!-- Subnet -->
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">Subnet (CIDR)</label>
                        <div class="flex gap-2">
                            <input x-model="createForm.subnet"
                                   @input.debounce.500ms="validateSubnet()"
                                   type="text" placeholder="e.g. 172.20.0.0/24"
                                   class="flex-1 bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500"
                                   :class="subnetValidation && !subnetValidation.valid ? 'border-red-500' : ''">
                        </div>
                        <!-- Validation message -->
                        <p x-show="subnetValidation && !subnetValidation.valid"
                           class="text-red-400 text-xs mt-1" x-text="subnetValidation.reason"></p>
                        <p x-show="subnetValidation && subnetValidation.valid"
                           class="text-green-400 text-xs mt-1">Subnet is valid</p>
                        <p class="text-slate-500 text-xs mt-1">Leave empty to let Docker auto-assign</p>
                    </div>

                    <!-- Gateway -->
                    <div x-show="createForm.subnet">
                        <label class="block text-sm text-slate-300 mb-1">Gateway</label>
                        <input x-model="createForm.gateway"
                               type="text" placeholder="e.g. 172.20.0.1 (auto if empty)"
                               class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500">
                    </div>

                    <!-- Purpose -->
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">Purpose / Description</label>
                        <input x-model="createForm.purpose"
                               type="text" placeholder="What is this network for?"
                               class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white placeholder-slate-500 focus:outline-none focus:border-purple-500">
                    </div>
                </div>

                <!-- Modal footer -->
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showCreateModal = false"
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded transition">
                        Cancel
                    </button>
                    <button @click="createNetwork()"
                            :disabled="creating || !createForm.name.trim()"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400 text-white rounded transition">
                        <span x-show="!creating">Create Network</span>
                        <span x-show="creating">Creating...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             DELETE CONFIRMATION MODAL
             ============================================================ -->
        <div x-show="networkToDelete"
             class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
            <div class="bg-slate-800 border border-slate-700 rounded-lg w-full max-w-md mx-4 p-6 shadow-xl">
                <h3 class="text-xl font-semibold text-white mb-2">Delete Network</h3>
                <p class="text-slate-400 mb-1">Are you sure you want to delete:</p>
                <p class="text-white font-mono font-semibold mb-4" x-text="networkToDelete ? networkToDelete.name : ''"></p>
                <p x-show="networkToDelete && networkToDelete.container_count > 0"
                   class="text-yellow-400 text-sm mb-4">
                    ‚ö† This network has <span x-text="networkToDelete ? networkToDelete.container_count : 0"></span> container(s) attached.
                    Disconnect them first.
                </p>
                <div class="flex justify-end gap-3">
                    <button @click="networkToDelete = null"
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded transition">
                        Cancel
                    </button>
                    <button @click="deleteNetwork()"
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition">
                        Delete
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             TOAST
             ============================================================ -->
        <div x-show="toast.show"
             class="fixed bottom-6 right-6 z-50 px-5 py-3 rounded-lg shadow-lg transition-all duration-300"
             :class="{
                 'bg-green-600': toast.type === 'success',
                 'bg-red-600':   toast.type === 'error',
                 'bg-blue-600':  toast.type === 'info'
             }">
            <p class="text-white" x-text="toast.message"></p>
        </div>
    </main>
</div>

<!-- ================================================================
     Alpine.js Component
     ================================================================ -->
<script>
function networksComponent() {
    return {
        // State
        networks: [],
        loading: true,
        selectedNetwork: null,        // expanded detail view
        recommendation: null,

        // Create modal
        showCreateModal: false,
        creating: false,
        createForm: { name: '', driver: 'bridge', subnet: '', gateway: '', purpose: '' },
        subnetValidation: null,

        // Delete modal
        networkToDelete: null,

        // Toast
        toast: { show: false, message: '', type: 'info' },

        // ---- computed ----
        get managedCount() {
            return this.networks.filter(n => n.managed).length;
        },
        get totalContainers() {
            return this.networks.reduce((sum, n) => sum + (n.container_count || 0), 0);
        },
        get oversizedCount() {
            return this.networks.filter(n => n.oversized).length;
        },

        // ---- lifecycle ----
        async init() {
            await Promise.all([this.loadNetworks(), this.loadRecommendation()]);
        },

        // ---- data loading ----
        async loadNetworks() {
            this.loading = true;
            try {
                const res = await fetch('/api/networks');
                const data = await res.json();
                if (data.success) {
                    this.networks = data.data;
                } else {
                    this.showToast('Failed to load networks: ' + data.error, 'error');
                }
            } catch (e) {
                this.showToast('Failed to load networks: ' + e.message, 'error');
            } finally {
                this.loading = false;
            }
        },

        async loadRecommendation() {
            try {
                const res = await fetch('/api/networks/recommend');
                const data = await res.json();
                if (data.success) {
                    this.recommendation = data.data;
                }
            } catch (e) {
                // non-fatal
            }
        },

        // ---- detail toggle ----
        async selectNetwork(network) {
            // If already selected, collapse
            if (this.selectedNetwork && this.selectedNetwork.network_id === network.network_id) {
                this.selectedNetwork = null;
                return;
            }
            // Fetch full details (includes containers)
            try {
                const res = await fetch('/api/networks/' + network.network_id);
                const data = await res.json();
                if (data.success) {
                    this.selectedNetwork = data.data;
                }
            } catch (e) {
                this.showToast('Failed to load network details', 'error');
            }
        },

        // ---- create ----
        applyRecommendation(size) {
            if (!this.recommendation) return;
            this.createForm.subnet = this.recommendation[size];
            this.subnetValidation = null;  // clear; user can re-validate
        },

        async validateSubnet() {
            if (!this.createForm.subnet.trim()) {
                this.subnetValidation = null;
                return;
            }
            try {
                const res = await fetch('/api/networks/validate-subnet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subnet: this.createForm.subnet })
                });
                this.subnetValidation = await res.json();
            } catch (e) {
                this.subnetValidation = { valid: false, reason: 'Validation request failed' };
            }
        },

        async createNetwork() {
            if (!this.createForm.name.trim()) return;
            // Block if subnet was entered but validation failed
            if (this.createForm.subnet && this.subnetValidation && !this.subnetValidation.valid) {
                this.showToast('Fix subnet validation errors first', 'error');
                return;
            }

            this.creating = true;
            try {
                const res = await fetch('/api/networks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name:    this.createForm.name.trim(),
                        driver:  this.createForm.driver,
                        subnet:  this.createForm.subnet || null,
                        gateway: this.createForm.gateway || null,
                        purpose: this.createForm.purpose || null
                    })
                });
                const data = await res.json();
                if (data.success) {
                    this.showToast(`Network '${data.name}' created`, 'success');
                    this.showCreateModal = false;
                    this.createForm = { name: '', driver: 'bridge', subnet: '', gateway: '', purpose: '' };
                    this.subnetValidation = null;
                    await this.loadNetworks();
                } else {
                    this.showToast(data.error, 'error');
                }
            } catch (e) {
                this.showToast('Failed to create network: ' + e.message, 'error');
            } finally {
                this.creating = false;
            }
        },

        // ---- delete ----
        confirmDelete(network) {
            this.networkToDelete = network;
        },

        async deleteNetwork() {
            if (!this.networkToDelete) return;
            const id = this.networkToDelete.network_id;
            const name = this.networkToDelete.name;
            this.networkToDelete = null;

            try {
                const res = await fetch('/api/networks/' + id, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    this.showToast(`Network '${name}' deleted`, 'success');
                    // Clear selection if it was the deleted network
                    if (this.selectedNetwork && this.selectedNetwork.network_id === id) {
                        this.selectedNetwork = null;
                    }
                    await this.loadNetworks();
                } else {
                    this.showToast(data.error, 'error');
                }
            } catch (e) {
                this.showToast('Failed to delete network: ' + e.message, 'error');
            }
        },

        // ---- toast ----
        showToast(message, type = 'info') {
            this.toast.message = message;
            this.toast.type = type;
            this.toast.show = true;
            setTimeout(() => { this.toast.show = false; }, 4000);
        }
    };
}
</script>
{% endblock %}
