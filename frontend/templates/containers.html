{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-slate-900" x-data="containersComponent()">
    {% include 'components/navbar.html' %}
    
    <!-- Toast Notification -->
    <div x-show="toast.show" 
         x-transition
         class="fixed top-4 right-4 z-50 max-w-md">
        <div :class="{
            'bg-green-600': toast.type === 'success',
            'bg-red-600': toast.type === 'error',
            'bg-blue-600': toast.type === 'info',
            'bg-yellow-600': toast.type === 'warning'
         }" class="text-white px-6 py-4 rounded-lg shadow-lg flex items-start space-x-3">
            <span class="text-2xl">
                <span x-show="toast.type === 'success'">‚úÖ</span>
                <span x-show="toast.type === 'error'">‚ùå</span>
                <span x-show="toast.type === 'info'">‚ÑπÔ∏è</span>
                <span x-show="toast.type === 'warning'">‚ö†Ô∏è</span>
            </span>
            <div class="flex-1">
                <p class="font-medium" x-text="toast.message"></p>
            </div>
            <button @click="toast.show = false" class="text-white hover:text-gray-200">
                ‚úï
            </button>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div x-show="deleteModal.show" 
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40"
         @click.self="closeDeleteModal()">
        <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4 border border-slate-700">
            <h3 class="text-xl font-bold text-white mb-4">Confirm Delete</h3>
            <p class="text-slate-300 mb-6">
                Are you sure you want to delete container 
                <strong class="text-white" x-text="deleteModal.containerName"></strong>?
                <span x-show="deleteModal.isRunning" class="text-yellow-400 block mt-2">
                    ‚ö†Ô∏è Container is currently running and will be force-removed.
                </span>
            </p>
            <div class="flex justify-end space-x-3">
                <button @click="closeDeleteModal()" 
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition">
                    Cancel
                </button>
                <button @click="confirmDelete()" 
                        :disabled="deleteModal.loading"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-red-400 disabled:cursor-not-allowed text-white rounded-md transition">
                    <span x-show="!deleteModal.loading">Delete</span>
                    <span x-show="deleteModal.loading">Deleting...</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Container Details Modal -->
    <div x-show="detailsModal.show" 
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40"
         @click.self="closeDetailsModal()">
        <div class="bg-slate-800 rounded-lg p-6 max-w-2xl w-full mx-4 border border-slate-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-white">Container Details</h3>
                <button @click="closeDetailsModal()" class="text-slate-400 hover:text-white text-2xl">
                    ‚úï
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Basic Information -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-slate-400 text-sm">Name</label>
                        <div class="text-white font-medium" x-text="detailsModal.container?.name"></div>
                    </div>
                    <div>
                        <label class="text-slate-400 text-sm">Status</label>
                        <div>
                            <span :class="{
                                'bg-green-900 text-green-300': detailsModal.container?.state === 'running',
                                'bg-red-900 text-red-300': detailsModal.container?.state === 'exited',
                                'bg-yellow-900 text-yellow-300': detailsModal.container?.state === 'paused',
                                'bg-gray-700 text-gray-300': !['running', 'exited', 'paused'].includes(detailsModal.container?.state)
                            }" class="px-2 py-1 rounded text-sm font-medium" x-text="detailsModal.container?.state"></span>
                        </div>
                    </div>
                    <div>
                        <label class="text-slate-400 text-sm">Image</label>
                        <div class="text-white font-mono text-sm" x-text="detailsModal.container?.image_name"></div>
                    </div>
                    <div>
                        <label class="text-slate-400 text-sm">Environment</label>
                        <div>
                            <span :class="{
                                'bg-green-900 text-green-300': detailsModal.container?.environment === 'DEV',
                                'bg-yellow-900 text-yellow-300': detailsModal.container?.environment === 'STG',
                                'bg-red-900 text-red-300': detailsModal.container?.environment === 'PROD'
                            }" class="px-2 py-1 rounded text-sm font-medium" x-text="detailsModal.container?.environment"></span>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Created:</span>
                            <span class="text-white text-sm" x-text="formatDate(detailsModal.container?.created_at)"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Ports -->
                <div x-show="detailsModal.container?.ports && detailsModal.container.ports.length > 0">
                    <label class="text-slate-400 text-sm">Port Mappings</label>
                    <div class="mt-1 bg-slate-900 rounded p-3">
                        <template x-for="port in detailsModal.container?.ports" :key="port">
                            <div class="text-white font-mono text-sm" x-text="port"></div>
                        </template>
                    </div>
                </div>
                
                <!-- Environment Variables -->
                <div x-show="detailsModal.container?.env_vars && detailsModal.container.env_vars.length > 0">
                    <label class="text-slate-400 text-sm">Environment Variables</label>
                    <div class="mt-1 bg-slate-900 rounded p-3 max-h-40 overflow-y-auto">
                        <template x-for="env in detailsModal.container?.env_vars" :key="env">
                            <div class="text-white font-mono text-sm" x-text="env"></div>
                        </template>
                    </div>
                </div>
                
                <!-- Volumes -->
                <div x-show="detailsModal.container?.volumes && detailsModal.container.volumes.length > 0">
                    <label class="text-slate-400 text-sm">Volume Mounts</label>
                    <div class="mt-1 bg-slate-900 rounded p-3">
                        <template x-for="volume in detailsModal.container?.volumes" :key="volume">
                            <div class="text-white font-mono text-sm" x-text="volume"></div>
                        </template>
                    </div>
                </div>
                
                <!-- CLI Command Equivalent -->
                <div>
                    <label class="text-slate-400 text-sm">Docker CLI Equivalent</label>
                    <div class="mt-1 bg-slate-900 rounded p-3 overflow-x-auto">
                        <pre class="text-green-400 font-mono text-xs whitespace-pre-wrap" x-text="generateDockerCommand(detailsModal.container)"></pre>
                    </div>
                    <p class="text-slate-500 text-xs mt-1">
                        üí° Educational: This is the equivalent CLI command to recreate this container
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Container Modal - MINIMAL SCROLL FIX -->
    <div x-show="createModal.show" 
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"
         @click.self="closeCreateModal()">
        <div class="bg-slate-800 rounded-lg p-6 max-w-4xl w-full border border-slate-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-white">Create Container</h3>
                    <p class="text-slate-400 text-sm mt-1">Configure and deploy a new Docker container</p>
                </div>
                <button @click="closeCreateModal()" class="text-slate-400 hover:text-white text-2xl">
                    ‚úï
                </button>
            </div>
            
            <!-- Error Banner -->
            <div x-show="createModal.errorMessage" class="mb-4 bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded">
                <p class="font-medium">Error:</p>
                <p x-text="createModal.errorMessage"></p>
            </div>
            
            <form @submit.prevent="submitCreateForm()" class="space-y-6">
                <!-- Basic Information Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <h4 class="text-lg font-semibold text-white mb-4">Basic Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Container Name -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Container Name <span class="text-red-400">*</span>
                            </label>
                            <input type="text" 
                                   x-model="createModal.formData.name"
                                   required
                                   placeholder="my-container"
                                   class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   :class="{'border-red-500': createModal.errors.name}">
                            <p class="text-xs text-slate-500 mt-1">Alphanumeric characters, hyphens, and underscores only</p>
                            <p x-show="createModal.errors.name" class="text-xs text-red-400 mt-1" x-text="createModal.errors.name"></p>
                        </div>
                        
                        <!-- Image Name -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Image Name <span class="text-red-400">*</span>
                            </label>
                            <input type="text" 
                                   x-model="createModal.formData.image"
                                   required
                                   placeholder="nginx:latest"
                                   class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   :class="{'border-red-500': createModal.errors.image}">
                            <p class="text-xs text-slate-500 mt-1">Docker image with optional tag (e.g., nginx:alpine)</p>
                            <p x-show="createModal.errors.image" class="text-xs text-red-400 mt-1" x-text="createModal.errors.image"></p>
                        </div>
                        
                        <!-- Environment Tag -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Environment <span class="text-red-400">*</span>
                            </label>
                            <select x-model="createModal.formData.environment"
                                    required
                                    class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="DEV">Development (DEV)</option>
                                <option value="STG">Staging (STG)</option>
                                <option value="PROD">Production (PROD)</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Environment classification for organization</p>
                        </div>
                        
                        <!-- Restart Policy -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Restart Policy
                            </label>
                            <select x-model="createModal.formData.restart_policy"
                                    class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="no">No restart</option>
                                <option value="on-failure">On failure only</option>
                                <option value="always">Always restart</option>
                                <option value="unless-stopped">Unless stopped manually</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">How Docker should handle container restarts</p>
                        </div>
                    </div>
                </div>
                
                <!-- Port Mappings Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-white">Port Mappings</h4>
                            <p class="text-xs text-slate-400 mt-1">Expose container ports to the host</p>
                        </div>
                        <button type="button" 
                                @click="addPort()"
                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition">
                            + Add Port
                        </button>
                    </div>
                    
                    <div x-show="createModal.formData.ports.length === 0" class="text-slate-500 text-sm italic">
                        No port mappings configured. Click "Add Port" to expose ports.
                    </div>
                    
                    <div class="space-y-2">
                        <template x-for="(port, index) in createModal.formData.ports" :key="index">
                            <div class="flex items-center space-x-2">
                                <input type="text" 
                                       x-model="port.container"
                                       placeholder="80/tcp"
                                       :class="{'border-red-500': createModal.errors['port_' + index]}"
                                       class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <span class="text-slate-400">‚Üí</span>
                                <input type="number" 
                                       x-model="port.host"
                                       min="1"
                                       max="65535"
                                       placeholder="8080"
                                       :class="{'border-red-500': createModal.errors['port_' + index]}"
                                       class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <button type="button" 
                                        @click="removePort(index)"
                                        class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition">
                                    Remove
                                </button>
                            </div>
                        </template>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">üí° Format: container_port/protocol ‚Üí host_port (e.g., 80/tcp ‚Üí 8080)</p>
                </div>
                
                <!-- Volume Mounts Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-white">Volume Mounts</h4>
                            <p class="text-xs text-slate-400 mt-1">Persist data or mount host directories</p>
                        </div>
                        <button type="button" 
                                @click="addVolume()"
                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition">
                            + Add Volume
                        </button>
                    </div>
                    
                    <div x-show="createModal.formData.volumes.length === 0" class="text-slate-500 text-sm italic">
                        No volume mounts configured. Click "Add Volume" to mount volumes.
                    </div>
                    
                    <div class="space-y-2">
                        <template x-for="(volume, index) in createModal.formData.volumes" :key="index">
                            <div class="flex items-center space-x-2">
                                <input type="text" 
                                       x-model="volume.host"
                                       placeholder="/host/path"
                                       :class="{'border-red-500': createModal.errors['volume_' + index]}"
                                       class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <span class="text-slate-400">‚Üí</span>
                                <input type="text" 
                                       x-model="volume.container"
                                       placeholder="/container/path"
                                       :class="{'border-red-500': createModal.errors['volume_' + index]}"
                                       class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <select x-model="volume.mode"
                                        class="px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option value="rw">Read-Write</option>
                                    <option value="ro">Read-Only</option>
                                </select>
                                <button type="button" 
                                        @click="removeVolume(index)"
                                        class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition">
                                    Remove
                                </button>
                            </div>
                        </template>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">üí° Format: /host/path ‚Üí /container/path with mode (rw = read-write, ro = read-only)</p>
                </div>
                
                <!-- Environment Variables Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-white">Environment Variables</h4>
                            <p class="text-xs text-slate-400 mt-1">Pass configuration to the container</p>
                        </div>
                        <button type="button" 
                                @click="addEnvVar()"
                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition">
                            + Add Variable
                        </button>
                    </div>
                    
                    <div x-show="createModal.formData.env_vars.length === 0" class="text-slate-500 text-sm italic">
                        No environment variables configured. Click "Add Variable" to add variables.
                    </div>
                    
                    <div class="space-y-2">
                        <template x-for="(envVar, index) in createModal.formData.env_vars" :key="index">
                            <div class="flex items-center space-x-2">
                                <input type="text" 
                                       x-model="envVar.key"
                                       placeholder="VARIABLE_NAME"
                                       :class="{'border-red-500': createModal.errors['env_' + index]}"
                                       class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <span class="text-slate-400">=</span>
                                <input type="text" 
                                       x-model="envVar.value"
                                       placeholder="value"
                                       :class="{'border-red-500': createModal.errors['env_' + index]}"
                                       class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <button type="button" 
                                        @click="removeEnvVar(index)"
                                        class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition">
                                    Remove
                                </button>
                            </div>
                        </template>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">üí° Format: KEY=value (e.g., DATABASE_URL=postgresql://...)</p>
                </div>
                
                <!-- Advanced Options Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <h4 class="text-lg font-semibold text-white mb-4">Advanced Options</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- CPU Limit -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                CPU Limit (cores)
                            </label>
                            <input type="number" 
                                   x-model="createModal.formData.cpu_limit"
                                   step="0.1"
                                   min="0.1"
                                   placeholder="1.0"
                                   class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Leave empty for unlimited (e.g., 1.5 = 1.5 CPU cores)</p>
                        </div>
                        
                        <!-- Memory Limit -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Memory Limit (MB)
                            </label>
                            <input type="number" 
                                   x-model="createModal.formData.memory_limit"
                                   min="4"
                                   placeholder="512"
                                   class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Leave empty for unlimited (minimum 4 MB)</p>
                        </div>
                        
                        <!-- Auto-start Checkbox -->
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" 
                                   x-model="createModal.formData.auto_start"
                                   id="auto-start"
                                   class="w-4 h-4 bg-slate-800 border-slate-600 rounded focus:ring-2 focus:ring-blue-500">
                            <label for="auto-start" class="text-sm text-slate-300">
                                Auto-start container after creation
                            </label>
                        </div>
                        
                        <!-- Pull-if-missing Checkbox -->
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" 
                                   x-model="createModal.formData.pull_if_missing"
                                   id="pull-missing"
                                   class="w-4 h-4 bg-slate-800 border-slate-600 rounded focus:ring-2 focus:ring-blue-500">
                            <label for="pull-missing" class="text-sm text-slate-300">
                                Pull image if not found locally
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-slate-700">
                    <button type="button" 
                            @click="closeCreateModal()"
                            :disabled="createModal.loading"
                            class="px-6 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-md transition">
                        Cancel
                    </button>
                    <button type="submit" 
                            :disabled="createModal.loading"
                            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed text-white rounded-md transition font-medium">
                        <span x-show="!createModal.loading">Create Container</span>
                        <span x-show="createModal.loading">Creating...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header with Hardware Stats -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 space-y-4 md:space-y-0">
            <div>
                <h2 class="text-3xl font-bold text-white">Containers</h2>
                <p class="text-slate-400 mt-1">Manage your Docker containers</p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Hardware Limits Display -->
                <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                    <div class="text-sm text-slate-400">Containers</div>
                    <div class="text-lg font-bold text-white">
                        <span x-text="runningCount"></span> / <span x-text="hardwareProfile.max_containers || '--'"></span>
                    </div>
                    <div class="text-xs text-slate-500" x-text="hardwareProfile.profile_name || 'Loading...'"></div>
                </div>
                
                <!-- Create Button -->
                <button @click="openCreateModal()"
                        :disabled="runningCount >= (hardwareProfile.max_containers || 999)"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed"
                        :title="runningCount >= (hardwareProfile.max_containers || 999) ? 'Hardware limit reached' : 'Create new container'">
                    <span class="mr-2">+</span> Create Container
                </button>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Search</label>
                    <input type="text" 
                           x-model="filters.search" 
                           @input="applyFilters()"
                           placeholder="Search by name or image..."
                           class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Status Filter -->
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Status</label>
                    <select x-model="filters.status" 
                            @change="applyFilters()"
                            class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Statuses</option>
                        <option value="running">Running</option>
                        <option value="exited">Stopped</option>
                        <option value="paused">Paused</option>
                    </select>
                </div>
                
                <!-- Environment Filter -->
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Environment</label>
                    <select x-model="filters.environment" 
                            @change="applyFilters()"
                            class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Environments</option>
                        <option value="DEV">Development</option>
                        <option value="STG">Staging</option>
                        <option value="PROD">Production</option>
                    </select>
                </div>
                
                <!-- Sync Button -->
                <div class="flex items-end">
                    <button @click="syncWithDocker()" 
                            :disabled="syncLoading"
                            class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400 disabled:cursor-not-allowed text-white rounded transition">
                        <span x-show="!syncLoading">üîÑ Sync with Docker</span>
                        <span x-show="syncLoading">‚è≥ Syncing...</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div x-show="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            <p class="text-slate-400 mt-4">Loading containers...</p>
        </div>
        
        <!-- Empty State -->
        <div x-show="!loading && filteredContainers.length === 0 && containers.length === 0" 
             class="text-center py-12 bg-slate-800 rounded-lg border border-slate-700">
            <p class="text-slate-400 text-lg">No containers found</p>
            <p class="text-slate-500 mt-2">Click "Create Container" to get started</p>
        </div>
        
        <!-- No Results from Filters -->
        <div x-show="!loading && filteredContainers.length === 0 && containers.length > 0" 
             class="text-center py-12 bg-slate-800 rounded-lg border border-slate-700">
            <p class="text-slate-400 text-lg">No containers match your filters</p>
            <p class="text-slate-500 mt-2">Try adjusting your search or filter criteria</p>
        </div>
        
        <!-- Containers Grid -->
        <div x-show="!loading && filteredContainers.length > 0" class="space-y-4">
            <template x-for="container in filteredContainers" :key="container.name">
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-6 hover:border-slate-600 transition">
                    <div class="flex justify-between items-start mb-4">
                        <!-- Container Info -->
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <h3 class="text-xl font-semibold text-white" x-text="container.name"></h3>
                                <span :class="{
                                    'bg-green-900 text-green-300': container.state === 'running',
                                    'bg-red-900 text-red-300': container.state === 'exited',
                                    'bg-yellow-900 text-yellow-300': container.state === 'paused',
                                    'bg-gray-700 text-gray-300': !['running', 'exited', 'paused'].includes(container.state)
                                }" class="px-2 py-1 rounded text-xs font-medium uppercase" x-text="container.state"></span>
                                <span :class="{
                                    'bg-green-900 text-green-300': container.environment === 'DEV',
                                    'bg-yellow-900 text-yellow-300': container.environment === 'STG',
                                    'bg-red-900 text-red-300': container.environment === 'PROD'
                                }" class="px-2 py-1 rounded text-xs font-medium" x-text="container.environment"></span>
                            </div>
                            <p class="text-slate-400 mt-1 font-mono text-sm" x-text="container.image_name"></p>
                            <p class="text-slate-500 text-xs mt-1">
                                Created: <span x-text="formatDate(container.created_at)"></span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Container Actions -->
                    <div class="flex flex-wrap gap-2">
                        <!-- Start Button -->
                        <button x-show="container.state !== 'running'"
                                @click="performAction(container.name, 'start')"
                                :disabled="actionLoading[container.name]"
                                title="Start container (docker start)"
                                class="px-3 py-2 bg-green-600 hover:bg-green-700 disabled:bg-green-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">‚ñ∂ Start</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>
                        
                        <!-- Stop Button -->
                        <button x-show="container.state === 'running'"
                                @click="performAction(container.name, 'stop')"
                                :disabled="actionLoading[container.name]"
                                title="Stop container (docker stop)"
                                class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 disabled:bg-yellow-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">‚è∏ Stop</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>
                        
                        <!-- Restart Button -->
                        <button x-show="container.state === 'running'"
                                @click="performAction(container.name, 'restart')"
                                :disabled="actionLoading[container.name]"
                                title="Restart container (docker restart)"
                                class="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">üîÑ Restart</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>
                        
                        <!-- Details Button -->
                        <button @click="showDetails(container)"
                                class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition text-sm font-medium">
                            ‚Ñπ Details
                        </button>
                        
                        <!-- Delete Button -->
                        <button @click="showDeleteConfirmation(container.name, container.name)"
                                :disabled="actionLoading[container.name]"
                                title="Delete container (docker rm)"
                                class="px-3 py-2 bg-red-600 hover:bg-red-700 disabled:bg-red-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">üóë Delete</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Auto-refresh Indicator -->
        <div x-show="!loading && containers.length > 0" class="mt-6 text-center">
            <p class="text-slate-500 text-sm">
                üîÑ Auto-refreshing every 10 seconds | Last updated: <span x-text="lastUpdated"></span>
            </p>
        </div>
    </main>
</div>

<script>
/**
 * Containers Page Alpine.js Component
 * 
 * Manages container list display, filtering, and actions (start/stop/restart/delete).
 * Implements hardware-aware container management with educational CLI equivalents.
 * 
 * Task 7 Addition: Container creation modal with comprehensive form validation.
 * 
 * Educational Notes:
 * - Container operations map to Docker CLI commands (shown in tooltips and details)
 * - Hardware limits enforced to prevent system overload
 * - Real-time sync with Docker daemon state
 */
function containersComponent() {
    return {
        // State management
        containers: [],
        filteredContainers: [],
        loading: false,
        syncLoading: false,
        lastUpdated: 'Never',
        pollInterval: null,
        hardwareProfile: {},
        runningCount: 0,
        actionLoading: {},
        
        // Filter state
        filters: {
            search: '',
            status: 'all',
            environment: 'all'
        },
        
        // Toast notification state
        toast: {
            show: false,
            message: '',
            type: 'info'
        },
        
        // Delete modal state
        deleteModal: {
            show: false,
            containerId: null,
            containerName: '',
            isRunning: false,
            loading: false
        },
        
        // Details modal state
        detailsModal: {
            show: false,
            container: null
        },
        
        // Create modal state (Task 7)
        createModal: {
            show: false,
            loading: false,
            errors: {},
            errorMessage: '',
            formData: {
                name: '',
                image: '',
                environment: 'DEV',
                ports: [],
                volumes: [],
                env_vars: [],
                restart_policy: 'unless-stopped',
                cpu_limit: null,
                memory_limit: null,
                auto_start: true,
                pull_if_missing: true
            }
        },
        
        /**
         * Initialize component
         */
        async init() {
            await this.loadHardwareProfile();
            await this.loadContainers();
            this.startPolling();
        },
        
        /**
         * Load hardware profile from API
         */
        async loadHardwareProfile() {
            try {
                const response = await fetch('/api/system/hardware');
                const data = await response.json();
                
                if (data.success) {
                    this.hardwareProfile = data.data;
                }
            } catch (error) {
                console.error('Failed to load hardware profile:', error);
            }
        },
        
        /**
         * Load containers from API
         * Educational: Equivalent to `docker ps -a`
         */
        async loadContainers() {
            this.loading = true;
            
            try {
                const response = await fetch('/api/containers');
                const data = await response.json();
                
                if (data.success) {
                    this.containers = data.data;
                    this.runningCount = this.containers.filter(c => c.state === 'running').length;
                    this.applyFilters();
                    this.lastUpdated = new Date().toLocaleTimeString();
                } else {
                    this.showToast('Failed to load containers: ' + data.message, 'error');
                }
            } catch (error) {
                this.showToast('Failed to load containers: ' + error.message, 'error');
            } finally {
                this.loading = false;
            }
        },
        
        /**
         * Sync database with Docker daemon state
         * Educational: Reconciles DockerMate database with actual Docker state
         * 
         * NOTE: Sync endpoint not yet implemented - just refresh container list
         */
        async syncWithDocker() {
            this.syncLoading = true;
            
            try {
                // Sync endpoint not yet implemented, just refresh the list
                await this.loadContainers();
                this.showToast('Container list refreshed', 'success');
            } catch (error) {
                this.showToast('Refresh failed: ' + error.message, 'error');
            } finally {
                this.syncLoading = false;
            }
        },
        
        /**
         * Apply filters to container list
         */
        applyFilters() {
            this.filteredContainers = this.containers.filter(container => {
                // Search filter
                const searchMatch = this.filters.search === '' || 
                    container.name.toLowerCase().includes(this.filters.search.toLowerCase()) ||
                    container.image_name.toLowerCase().includes(this.filters.search.toLowerCase());
                
                // Status filter
                const statusMatch = this.filters.status === 'all' || container.state === this.filters.status;
                
                // Environment filter
                const envMatch = this.filters.environment === 'all' || container.environment === this.filters.environment;
                
                return searchMatch && statusMatch && envMatch;
            });
        },
        
        /**
         * Perform container action (start/stop/restart)
         * Educational: Maps to Docker CLI commands
         */
        async performAction(containerId, action) {
            this.actionLoading[containerId] = true;
            
            try {
                const response = await fetch(`/api/containers/${containerId}/${action}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    this.showToast(`Container ${action} successful`, 'success');
                    await this.loadContainers();
                } else {
                    this.showToast(`Failed to ${action} container: ${data.message}`, 'error');
                }
            } catch (error) {
                this.showToast(`Failed to ${action} container: ${error.message}`, 'error');
            } finally {
                this.actionLoading[containerId] = false;
            }
        },
        
        /**
         * Show delete confirmation modal
         */
        showDeleteConfirmation(containerId, containerName) {
            const container = this.containers.find(c => c.name === containerId);
            this.deleteModal.containerId = containerId;
            this.deleteModal.containerName = containerName;
            this.deleteModal.isRunning = container && container.state === 'running';
            this.deleteModal.show = true;
        },
        
        /**
         * Close delete modal
         */
        closeDeleteModal() {
            this.deleteModal.show = false;
            this.deleteModal.containerId = null;
            this.deleteModal.containerName = '';
            this.deleteModal.isRunning = false;
        },
        
        /**
         * Confirm and execute delete
         * Educational: Equivalent to `docker rm -f <container>`
         */
        async confirmDelete() {
            this.deleteModal.loading = true;
            
            try {
                const response = await fetch(`/api/containers/${this.deleteModal.containerId}?force=true`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    this.showToast('Container deleted successfully', 'success');
                    this.closeDeleteModal();
                    await this.loadContainers();
                } else {
                    this.showToast('Failed to delete container: ' + data.message, 'error');
                }
            } catch (error) {
                this.showToast('Failed to delete container: ' + error.message, 'error');
            } finally {
                this.deleteModal.loading = false;
            }
        },
        
        /**
         * Show container details modal
         */
        showDetails(container) {
            this.detailsModal.container = container;
            this.detailsModal.show = true;
        },
        
        /**
         * Close details modal
         */
        closeDetailsModal() {
            this.detailsModal.show = false;
            this.detailsModal.container = null;
        },
        
        /**
         * Task 7: Open create container modal
         */
        openCreateModal() {
            // Reset form data
            this.createModal.formData = {
                name: '',
                image: '',
                environment: 'DEV',
                ports: [],
                volumes: [],
                env_vars: [],
                restart_policy: 'unless-stopped',
                cpu_limit: null,
                memory_limit: null,
                auto_start: true,
                pull_if_missing: true
            };
            this.createModal.errors = {};
            this.createModal.errorMessage = '';
            this.createModal.show = true;
        },
        
        /**
         * Task 7: Close create modal
         */
        closeCreateModal() {
            this.createModal.show = false;
        },
        
        /**
         * Task 7: Add port mapping entry
         */
        addPort() {
            this.createModal.formData.ports.push({
                container: '',
                host: ''
            });
        },
        
        /**
         * Task 7: Remove port mapping entry
         */
        removePort(index) {
            this.createModal.formData.ports.splice(index, 1);
        },
        
        /**
         * Task 7: Add volume mount entry
         */
        addVolume() {
            this.createModal.formData.volumes.push({
                host: '',
                container: '',
                mode: 'rw'
            });
        },
        
        /**
         * Task 7: Remove volume mount entry
         */
        removeVolume(index) {
            this.createModal.formData.volumes.splice(index, 1);
        },
        
        /**
         * Task 7: Add environment variable entry
         */
        addEnvVar() {
            this.createModal.formData.env_vars.push({
                key: '',
                value: ''
            });
        },
        
        /**
         * Task 7: Remove environment variable entry
         */
        removeEnvVar(index) {
            this.createModal.formData.env_vars.splice(index, 1);
        },
        
        /**
         * Task 7: Validate form client-side
         */
        validateForm() {
            const errors = {};
            const formData = this.createModal.formData;
            
            // Validate required fields
            if (!formData.name || !formData.name.trim()) {
                errors.name = 'Container name is required';
            } else if (!/^[a-zA-Z0-9_-]+$/.test(formData.name)) {
                errors.name = 'Name must contain only alphanumeric characters, hyphens, and underscores';
            }
            
            if (!formData.image || !formData.image.trim()) {
                errors.image = 'Image name is required';
            }
            
            // Validate port mappings - only check if at least one field is filled
            formData.ports.forEach((port, index) => {
                const hasAnyValue = port.container || port.host;
                if (hasAnyValue) {
                    if (!port.container) {
                        errors[`port_${index}`] = 'Container port is required';
                    } else if (!port.container.includes('/')) {
                        errors[`port_${index}`] = 'Container port must include protocol (e.g., 80/tcp)';
                    }
                    
                    if (!port.host) {
                        errors[`port_${index}`] = 'Host port is required';
                    } else if (port.host < 1 || port.host > 65535) {
                        errors[`port_${index}`] = 'Host port must be between 1 and 65535';
                    }
                }
            });
            
            // Validate volumes - only check if at least one field is filled
            formData.volumes.forEach((volume, index) => {
                const hasAnyValue = volume.host || volume.container;
                if (hasAnyValue) {
                    if (!volume.host) {
                        errors[`volume_${index}`] = 'Host path is required';
                    }
                    if (!volume.container) {
                        errors[`volume_${index}`] = 'Container path is required';
                    }
                }
            });
            
            // Validate environment variables - only check if at least one field is filled
            formData.env_vars.forEach((envVar, index) => {
                const hasAnyValue = envVar.key || envVar.value;
                if (hasAnyValue) {
                    if (!envVar.key) {
                        errors[`env_${index}`] = 'Variable name is required';
                    }
                    if (!envVar.value) {
                        errors[`env_${index}`] = 'Variable value is required';
                    }
                }
            });
            
            // Validate resource limits
            if (formData.cpu_limit !== null && formData.cpu_limit !== '' && formData.cpu_limit <= 0) {
                errors.cpu_limit = 'CPU limit must be greater than 0';
            }
            
            if (formData.memory_limit !== null && formData.memory_limit !== '' && formData.memory_limit < 4) {
                errors.memory_limit = 'Memory limit must be at least 4 MB';
            }
            
            this.createModal.errors = errors;
            
            // Build detailed error message for banner
            if (Object.keys(errors).length > 0) {
                const errorFields = [];
                if (errors.name) errorFields.push('Container Name');
                if (errors.image) errorFields.push('Image Name');
                
                // Check for port errors
                const portErrors = Object.keys(errors).filter(k => k.startsWith('port_'));
                if (portErrors.length > 0) errorFields.push('Port Mappings');
                
                // Check for volume errors
                const volumeErrors = Object.keys(errors).filter(k => k.startsWith('volume_'));
                if (volumeErrors.length > 0) errorFields.push('Volume Mounts');
                
                // Check for env var errors
                const envErrors = Object.keys(errors).filter(k => k.startsWith('env_'));
                if (envErrors.length > 0) errorFields.push('Environment Variables');
                
                if (errors.cpu_limit) errorFields.push('CPU Limit');
                if (errors.memory_limit) errorFields.push('Memory Limit');
                
                this.createModal.errorMessage = `Please fix the following: ${errorFields.join(', ')}`;
            }
            
            return Object.keys(errors).length === 0;
        },
        
        /**
         * Task 7: Submit create form
         * Educational: Equivalent to `docker run` with all specified options
         */
        async submitCreateForm() {
            // Reset previous errors
            this.createModal.errorMessage = '';
            this.createModal.errors = {};
            
            // Validate form
            if (!this.validateForm()) {
                this.createModal.errorMessage = 'Please fix the errors in the form';
                return;
            }
            
            this.createModal.loading = true;
            
            try {
                // Transform form data to API format
                const requestData = {
                    name: this.createModal.formData.name.trim(),
                    image: this.createModal.formData.image.trim(),
                    environment: this.createModal.formData.environment,
                    restart_policy: this.createModal.formData.restart_policy,
                    auto_start: this.createModal.formData.auto_start,
                    pull_if_missing: this.createModal.formData.pull_if_missing
                };
                
                // Transform ports array to API format
                if (this.createModal.formData.ports.length > 0) {
                    requestData.ports = {};
                    this.createModal.formData.ports.forEach(port => {
                        if (port.container && port.host) {
                            requestData.ports[port.container] = parseInt(port.host);
                        }
                    });
                }
                
                // Transform volumes array to API format
                if (this.createModal.formData.volumes.length > 0) {
                    requestData.volumes = {};
                    this.createModal.formData.volumes.forEach(volume => {
                        if (volume.host && volume.container) {
                            requestData.volumes[volume.host] = {
                                bind: volume.container,
                                mode: volume.mode
                            };
                        }
                    });
                }
                
                // Transform env vars array to API format
                if (this.createModal.formData.env_vars.length > 0) {
                    requestData.env_vars = {};
                    this.createModal.formData.env_vars.forEach(envVar => {
                        if (envVar.key && envVar.value) {
                            requestData.env_vars[envVar.key] = envVar.value;
                        }
                    });
                }
                
                // Add resource limits if specified
                if (this.createModal.formData.cpu_limit) {
                    requestData.cpu_limit = parseFloat(this.createModal.formData.cpu_limit);
                }
                
                if (this.createModal.formData.memory_limit) {
                    // Convert MB to bytes for API
                    requestData.memory_limit = parseInt(this.createModal.formData.memory_limit) * 1024 * 1024;
                }
                
                // Make API request
                const response = await fetch('/api/containers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.showToast(`Container "${requestData.name}" created successfully`, 'success');
                    this.closeCreateModal();
                    await this.loadContainers();
                } else {
                    // Handle API validation errors
                    if (data.error_type === 'validation_error') {
                        this.createModal.errorMessage = data.message;
                    } else if (data.error_type === 'docker_error') {
                        this.createModal.errorMessage = `Docker error: ${data.message}`;
                    } else {
                        this.createModal.errorMessage = data.message;
                    }
                }
            } catch (error) {
                this.createModal.errorMessage = `Failed to create container: ${error.message}`;
            } finally {
                this.createModal.loading = false;
            }
        },
        
        /**
         * Generate Docker CLI command equivalent
         * Educational: Shows how the container can be recreated via CLI
         */
        generateDockerCommand(container) {
            if (!container) return '';
            
            let cmd = 'docker run -d';
            
            // Add name
            cmd += ` \\\n  --name ${container.name}`;
            
            // Add restart policy
            if (container.restart_policy) {
                cmd += ` \\\n  --restart ${container.restart_policy}`;
            }
            
            // Add ports
            if (container.ports && container.ports.length > 0) {
                container.ports.forEach(port => {
                    cmd += ` \\\n  -p ${port}`;
                });
            }
            
            // Add environment variables
            if (container.env_vars && container.env_vars.length > 0) {
                container.env_vars.forEach(env => {
                    cmd += ` \\\n  -e "${env}"`;
                });
            }
            
            // Add volumes
            if (container.volumes && container.volumes.length > 0) {
                container.volumes.forEach(volume => {
                    cmd += ` \\\n  -v ${volume}`;
                });
            }
            
            // Add labels
            if (container.labels) {
                Object.entries(container.labels).forEach(([key, value]) => {
                    cmd += ` \\\n  --label ${key}=${value}`;
                });
            }
            
            // Add image
            cmd += ` \\\n  ${container.image_name}`;
            
            return cmd;
        },
        
        /**
         * Format date for display
         */
        formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        },
        
        /**
         * Show toast notification
         */
        showToast(message, type = 'info') {
            this.toast.message = message;
            this.toast.type = type;
            this.toast.show = true;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                this.toast.show = false;
            }, 5000);
        },
        
        /**
         * Start auto-refresh polling (every 10 seconds)
         * Educational note: Keeps UI in sync with Docker daemon state
         */
        startPolling() {
            this.pollInterval = setInterval(() => {
                if (!this.loading && !this.deleteModal.show && !this.detailsModal.show && !this.createModal.show) {
                    this.loadContainers();
                }
            }, 10000); // 10 seconds
        },
        
        /**
         * Cleanup on component destroy
         */
        destroy() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
            }
        }
    }
}
</script>
{% endblock %}