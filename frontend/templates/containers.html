{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-slate-900" x-data="containersComponent()">
    {% include 'components/navbar.html' %}
    
    <!-- Toast Notification -->
    <div x-show="toast.show" 
         x-transition
         class="fixed top-4 right-4 z-50 max-w-md">
        <div :class="{
            'bg-green-600': toast.type === 'success',
            'bg-red-600': toast.type === 'error',
            'bg-blue-600': toast.type === 'info',
            'bg-yellow-600': toast.type === 'warning'
         }" class="text-white px-6 py-4 rounded-lg shadow-lg flex items-start space-x-3">
            <span class="text-2xl">
                <span x-show="toast.type === 'success'">‚úÖ</span>
                <span x-show="toast.type === 'error'">‚ùå</span>
                <span x-show="toast.type === 'info'">‚ÑπÔ∏è</span>
                <span x-show="toast.type === 'warning'">‚ö†Ô∏è</span>
            </span>
            <div class="flex-1">
                <p class="font-medium" x-text="toast.message"></p>
            </div>
            <button @click="toast.show = false" class="text-white hover:text-gray-200">
                ‚úï
            </button>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div x-show="deleteModal.show"
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40"
         @click.self="closeDeleteModal()">
        <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4 border border-slate-700">
            <h3 class="text-xl font-bold text-white mb-4">Confirm Delete</h3>
            <p class="text-slate-300 mb-6">
                Are you sure you want to delete container
                <strong class="text-white" x-text="deleteModal.containerName"></strong>?
                <span x-show="deleteModal.isRunning" class="text-yellow-400 block mt-2">
                    ‚ö†Ô∏è Container is currently running and will be force-removed.
                </span>
            </p>
            <div class="flex justify-end space-x-3">
                <button @click="closeDeleteModal()"
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition">
                    Cancel
                </button>
                <button @click="confirmDelete()"
                        :disabled="deleteModal.loading"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-red-400 disabled:cursor-not-allowed text-white rounded-md transition">
                    <span x-show="!deleteModal.loading">Delete</span>
                    <span x-show="deleteModal.loading">Deleting...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Retag Modal (FEAT-013) -->
    <div x-show="retagModal.show"
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40"
         @click.self="retagModal.show = false">
        <div class="bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4 border border-slate-700">
            <h3 class="text-xl font-bold text-white mb-4">Retag Container</h3>
            <p class="text-slate-400 text-sm mb-1">Container: <strong class="text-white" x-text="retagModal.container?.name"></strong></p>
            <p class="text-slate-400 text-sm mb-4">Current image: <code class="text-indigo-300" x-text="retagModal.currentImage"></code></p>

            <label class="block text-slate-300 text-sm font-medium mb-1">New tag</label>
            <input type="text"
                   x-model="retagModal.newTag"
                   placeholder="e.g. 1.29, latest"
                   class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-white placeholder-slate-500 focus:outline-none focus:border-indigo-500 mb-2">

            <div x-show="retagModal.error" class="text-red-400 text-sm mb-2" x-text="retagModal.error"></div>

            <div class="flex justify-end space-x-3 mt-4">
                <button @click="retagModal.show = false"
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition">
                    Cancel
                </button>
                <button @click="submitRetag()"
                        :disabled="retagModal.loading || !retagModal.newTag.trim()"
                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 disabled:cursor-not-allowed text-white rounded-md transition">
                    <span x-show="!retagModal.loading">Retag & Redeploy</span>
                    <span x-show="retagModal.loading">Retagging...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Operations Confirmation Modal -->
    <div x-show="bulkModal.show"
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40"
         @click.self="!bulkModal.loading && closeBulkModal()">
        <div class="bg-slate-800 rounded-lg p-6 max-w-2xl w-full mx-4 border border-slate-700 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-4">
                <span x-text="bulkModal.completed ? 'Bulk Operation Results' : 'Confirm Bulk Operation'"></span>
            </h3>

            <!-- Confirmation View -->
            <div x-show="!bulkModal.completed">
                <p class="text-slate-300 mb-4">
                    Are you sure you want to <strong class="text-white" x-text="bulkModal.operationLabel"></strong>
                    <strong class="text-white" x-text="selectedContainers.length"></strong> container(s)?
                </p>

                <!-- Warning for delete operation with running containers -->
                <div x-show="bulkModal.operation === 'delete' && containers.filter(c => selectedContainers.includes(c.name) && c.state === 'running').length > 0"
                     class="bg-yellow-900 border border-yellow-700 text-yellow-200 px-4 py-3 rounded mb-4">
                    <p class="font-medium">‚ö†Ô∏è Warning</p>
                    <p class="text-sm mt-1">
                        <span x-text="containers.filter(c => selectedContainers.includes(c.name) && c.state === 'running').length"></span>
                        running container(s) will be force-removed.
                    </p>
                </div>

                <!-- Container List -->
                <div class="bg-slate-900 rounded p-4 mb-6 max-h-60 overflow-y-auto">
                    <template x-for="containerName in selectedContainers" :key="containerName">
                        <div class="flex items-center justify-between text-white font-mono text-sm py-1">
                            <span x-text="containerName"></span>
                            <span x-show="containers.find(c => c.name === containerName)?.state === 'running'"
                                  class="text-xs bg-green-900 text-green-300 px-2 py-0.5 rounded">
                                RUNNING
                            </span>
                        </div>
                    </template>
                </div>

                <div class="flex justify-end space-x-3">
                    <button @click="closeBulkModal()"
                            :disabled="bulkModal.loading"
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-md transition">
                        Cancel
                    </button>
                    <button @click="executeBulkOperation()"
                            :disabled="bulkModal.loading"
                            :class="{
                                'bg-green-600 hover:bg-green-700': bulkModal.operation === 'start',
                                'bg-yellow-600 hover:bg-yellow-700': bulkModal.operation === 'stop',
                                'bg-blue-600 hover:bg-blue-700': bulkModal.operation === 'restart',
                                'bg-red-600 hover:bg-red-700': bulkModal.operation === 'delete'
                            }"
                            class="px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-md transition">
                        <span x-show="!bulkModal.loading" x-text="'Confirm ' + bulkModal.operationLabel"></span>
                        <span x-show="bulkModal.loading">Processing...</span>
                    </button>
                </div>
            </div>

            <!-- Results View -->
            <div x-show="bulkModal.completed">
                <div class="space-y-2 mb-6 max-h-96 overflow-y-auto">
                    <template x-for="result in bulkModal.results" :key="result.container">
                        <div :class="{
                            'bg-green-900 border-green-700': result.success,
                            'bg-red-900 border-red-700': !result.success
                        }" class="border rounded p-3">
                            <div class="flex items-center justify-between">
                                <span class="text-white font-mono text-sm" x-text="result.container"></span>
                                <span x-show="result.success" class="text-green-300">‚úì</span>
                                <span x-show="!result.success" class="text-red-300">‚úó</span>
                            </div>
                            <p x-show="result.message" class="text-xs mt-1"
                               :class="result.success ? 'text-green-300' : 'text-red-300'"
                               x-text="result.message"></p>
                        </div>
                    </template>
                </div>

                <div class="flex justify-end">
                    <button @click="closeBulkModal()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container Details Modal -->
    <div x-show="detailsModal.show" 
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40"
         @click.self="closeDetailsModal()">
        <div class="bg-slate-800 rounded-lg p-6 max-w-2xl w-full mx-4 border border-slate-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-white">Container Details</h3>
                <button @click="closeDetailsModal()" class="text-slate-400 hover:text-white text-2xl">
                    ‚úï
                </button>
            </div>
            
            <div class="space-y-4">
                <!-- Basic Information -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-slate-400 text-sm">Name</label>
                        <div class="text-white font-medium" x-text="detailsModal.container?.name"></div>
                    </div>
                    <div>
                        <label class="text-slate-400 text-sm">Status</label>
                        <div>
                            <span :class="{
                                'bg-green-900 text-green-300': detailsModal.container?.state === 'running',
                                'bg-red-900 text-red-300': detailsModal.container?.state === 'exited',
                                'bg-yellow-900 text-yellow-300': detailsModal.container?.state === 'paused',
                                'bg-gray-700 text-gray-300': !['running', 'exited', 'paused'].includes(detailsModal.container?.state)
                            }" class="px-2 py-1 rounded text-sm font-medium uppercase" x-text="detailsModal.container?.state"></span>
                        </div>
                    </div>
                    <div>
                        <label class="text-slate-400 text-sm">Image</label>
                        <div class="text-white font-mono text-sm" x-text="detailsModal.container?.image_name"></div>
                    </div>
                    <div>
                        <label class="text-slate-400 text-sm">Environment</label>
                        <div>
                            <span :class="{
                                'bg-green-900 text-green-300': detailsModal.container?.environment === 'DEV',
                                'bg-yellow-900 text-yellow-300': detailsModal.container?.environment === 'STG',
                                'bg-red-900 text-red-300': detailsModal.container?.environment === 'PROD'
                            }" class="px-2 py-1 rounded text-sm font-medium" x-text="detailsModal.container?.environment"></span>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <div class="flex justify-between">
                            <span class="text-slate-400">Created:</span>
                            <span class="text-white text-sm" x-text="formatDate(detailsModal.container?.created_at)"></span>
                        </div>
                    </div>
                </div>

                <!-- Resource Limits -->
                <div x-show="detailsModal.container?.cpu_limit || detailsModal.container?.memory_limit">
                    <label class="text-slate-400 text-sm">Resource Limits</label>
                    <div class="mt-1 bg-slate-900 rounded p-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div x-show="detailsModal.container?.cpu_limit">
                                <span class="text-slate-400 text-xs">CPU Limit:</span>
                                <div class="text-white font-mono text-sm">
                                    <span x-text="detailsModal.container?.cpu_limit"></span> cores
                                </div>
                            </div>
                            <div x-show="detailsModal.container?.memory_limit">
                                <span class="text-slate-400 text-xs">Memory Limit:</span>
                                <div class="text-white font-mono text-sm">
                                    <span x-text="Math.round(detailsModal.container?.memory_limit / (1024 * 1024))"></span> MB
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ports -->
                <div x-show="detailsModal.container?.ports && detailsModal.container.ports.length > 0">
                    <label class="text-slate-400 text-sm">Port Mappings</label>
                    <div class="mt-1 bg-slate-900 rounded p-3 space-y-1">
                        <template x-for="(port, index) in detailsModal.container?.ports" :key="`port-${index}`">
                            <div class="text-white font-mono text-sm">
                                <span class="text-blue-400" x-text="port.host"></span>
                                <span class="text-slate-500"> ‚Üí </span>
                                <span x-text="port.container"></span>
                                <span class="text-slate-400" x-text="`/${port.protocol || 'tcp'}`"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Environment Variables -->
                <div x-show="detailsModal.container?.env_vars && detailsModal.container.env_vars.length > 0">
                    <label class="text-slate-400 text-sm">Environment Variables</label>
                    <div class="mt-1 bg-slate-900 rounded p-3 max-h-40 overflow-y-auto">
                        <template x-for="(env, index) in detailsModal.container?.env_vars" :key="`env-${index}`">
                            <div class="text-white font-mono text-sm" x-text="env"></div>
                        </template>
                    </div>
                </div>
                
                <!-- Volumes -->
                <div x-show="detailsModal.container?.volumes && detailsModal.container.volumes.length > 0">
                    <label class="text-slate-400 text-sm">Volume Mounts</label>
                    <div class="mt-1 bg-slate-900 rounded p-3">
                        <template x-for="(volume, index) in detailsModal.container?.volumes" :key="`volume-${index}`">
                            <div class="text-white font-mono text-sm" x-text="volume.source + ':' + volume.destination + ':' + volume.mode"></div>
                        </template>
                    </div>
                </div>
                
                <!-- CLI Command Equivalent -->
                <div>
                    <label class="text-slate-400 text-sm">Docker CLI Equivalent</label>
                    <div class="mt-1 bg-slate-900 rounded p-3 overflow-x-auto">
                        <pre class="text-green-400 font-mono text-xs whitespace-pre-wrap" x-text="generateDockerCommand(detailsModal.container)"></pre>
                    </div>
                    <p class="text-slate-500 text-xs mt-1">
                        üí° Educational: This is the equivalent CLI command to recreate this container
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Viewer Modal -->
    <div x-show="logsModal.show"
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"
         @click.self="closeLogsModal()">
        <div class="bg-slate-800 rounded-lg p-6 max-w-6xl w-full border border-slate-700 max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-2xl font-bold text-white">Container Logs</h3>
                    <p class="text-slate-400 text-sm mt-1">
                        <span x-text="logsModal.containerName"></span>
                        <span x-show="logsModal.containerId" class="text-slate-500 ml-2" x-text="`(${logsModal.containerId?.substring(0, 12)})`"></span>
                    </p>
                </div>
                <button @click="closeLogsModal()" class="text-slate-400 hover:text-white text-2xl">‚úï</button>
            </div>

            <!-- Controls -->
            <div class="bg-slate-900 rounded-lg p-4 mb-4 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <!-- Tail Lines -->
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Lines</label>
                        <select x-model="logsModal.tail" @change="fetchLogs()" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white text-sm">
                            <option value="100">Last 100</option>
                            <option value="500">Last 500</option>
                            <option value="1000">Last 1000</option>
                            <option value="all">All</option>
                        </select>
                    </div>

                    <!-- Timestamps -->
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Timestamps</label>
                        <select x-model="logsModal.timestamps" @change="fetchLogs()" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white text-sm">
                            <option value="false">Hide</option>
                            <option value="true">Show</option>
                        </select>
                    </div>

                    <!-- Auto-refresh -->
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Auto-refresh</label>
                        <select x-model="logsModal.autoRefresh" @change="toggleAutoRefresh()" class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white text-sm">
                            <option value="false">Off</option>
                            <option value="5">5 seconds</option>
                            <option value="10">10 seconds</option>
                        </select>
                    </div>

                    <!-- Actions -->
                    <div class="flex items-end gap-2">
                        <button @click="fetchLogs()" :disabled="logsModal.loading" class="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white rounded text-sm transition">
                            <span x-show="!logsModal.loading">Refresh</span>
                            <span x-show="logsModal.loading">...</span>
                        </button>
                        <button @click="downloadLogs()" class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm transition" title="Download logs">
                            ‚¨á
                        </button>
                    </div>
                </div>

                <!-- Search -->
                <div>
                    <input type="text"
                           x-model="logsModal.searchTerm"
                           @input="filterLogs()"
                           placeholder="üîç Search logs..."
                           class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white text-sm placeholder-slate-500">
                </div>

                <!-- Docker CLI Command -->
                <div class="bg-slate-950 rounded p-2">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs text-slate-500">Docker CLI Equivalent:</span>
                        <button @click="copyCliCommand()" class="text-xs text-blue-400 hover:text-blue-300">Copy</button>
                    </div>
                    <code class="text-xs text-green-400 font-mono" x-text="logsModal.cliCommand"></code>
                </div>
            </div>

            <!-- Logs Display -->
            <div class="flex-1 bg-slate-950 rounded-lg p-4 overflow-y-auto min-h-0 font-mono text-sm">
                <div x-show="logsModal.loading" class="text-slate-500 text-center py-8">Loading logs...</div>
                <div x-show="!logsModal.loading && logsModal.error" class="text-red-400 text-center py-8" x-text="logsModal.error"></div>
                <div x-show="!logsModal.loading && !logsModal.error && !logsModal.filteredLogs" class="text-slate-500 text-center py-8">No logs available</div>
                <pre x-show="!logsModal.loading && !logsModal.error && logsModal.filteredLogs"
                     class="text-slate-300 whitespace-pre-wrap break-all overflow-x-auto"
                     x-text="logsModal.filteredLogs"></pre>
            </div>

            <!-- Footer Stats -->
            <div class="mt-4 text-xs text-slate-500 flex justify-between items-center">
                <div>
                    <span x-text="logsModal.lineCount"></span> lines
                    <span x-show="logsModal.truncated" class="text-yellow-400 ml-2">(truncated)</span>
                    <span x-show="logsModal.searchTerm" class="text-blue-400 ml-2">
                        (filtered: <span x-text="logsModal.matchCount"></span> matches)
                    </span>
                </div>
                <div x-show="logsModal.lastUpdated">
                    Last updated: <span x-text="logsModal.lastUpdated"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Container Modal - MINIMAL SCROLL FIX -->
    <div x-show="createModal.show" 
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"
         @click.self="closeCreateModal()">
        <div class="bg-slate-800 rounded-lg p-6 max-w-4xl w-full border border-slate-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-white">Create Container</h3>
                    <p class="text-slate-400 text-sm mt-1">Configure and deploy a new Docker container</p>
                </div>
                <button @click="closeCreateModal()" class="text-slate-400 hover:text-white text-2xl">
                    ‚úï
                </button>
            </div>
            
            <!-- Error Banner -->
            <div x-show="createModal.errorMessage" class="mb-4 bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded">
                <p class="font-medium">Error:</p>
                <p x-text="createModal.errorMessage"></p>
            </div>
            
            <form @submit.prevent="submitCreateForm()" class="space-y-6">
                <!-- Basic Information Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <h4 class="text-lg font-semibold text-white mb-4">Basic Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Container Name -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Container Name <span class="text-red-400">*</span>
                            </label>
                            <input type="text" 
                                   x-model="createModal.formData.name"
                                   required
                                   placeholder="my-container"
                                   class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   :class="{'border-red-500': createModal.errors.name}">
                            <p class="text-xs text-slate-500 mt-1">Alphanumeric characters, hyphens, and underscores only</p>
                            <p x-show="createModal.errors.name" class="text-xs text-red-400 mt-1" x-text="createModal.errors.name"></p>
                        </div>
                        
                        <!-- Image Name -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Image Name <span class="text-red-400">*</span>
                            </label>
                            <input type="text" 
                                   x-model="createModal.formData.image"
                                   required
                                   placeholder="nginx:latest"
                                   class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   :class="{'border-red-500': createModal.errors.image}">
                            <p class="text-xs text-slate-500 mt-1">Docker image with optional tag (e.g., nginx:alpine)</p>
                            <p x-show="createModal.errors.image" class="text-xs text-red-400 mt-1" x-text="createModal.errors.image"></p>
                        </div>
                        
                        <!-- Environment Tag -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Environment <span class="text-red-400">*</span>
                            </label>
                            <select x-model="createModal.formData.environment"
                                    required
                                    class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="DEV">Development (DEV)</option>
                                <option value="STG">Staging (STG)</option>
                                <option value="PROD">Production (PROD)</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Environment classification for organization</p>
                        </div>
                        
                        <!-- Restart Policy -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Restart Policy
                            </label>
                            <select x-model="createModal.formData.restart_policy"
                                    class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="no">No restart</option>
                                <option value="on-failure">On failure only</option>
                                <option value="always">Always restart</option>
                                <option value="unless-stopped">Unless stopped manually</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">How Docker should handle container restarts</p>
                        </div>

                        <!-- Network -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">Network</label>
                            <select x-model="createModal.formData.network"
                                    class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Default (bridge)</option>
                                <template x-for="net in createModal.networks" :key="net.network_id">
                                    <option :value="net.name" x-text="net.name + (net.subnet ? ' (' + net.subnet + ')' : '')"></option>
                                </template>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Which network should this container join?</p>
                        </div>
                    </div>
                </div>
                
                <!-- Port Mappings Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-white">Port Mappings</h4>
                            <p class="text-xs text-slate-400 mt-1">Expose container ports to the host</p>
                        </div>
                        <button type="button" 
                                @click="addPort()"
                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition">
                            + Add Port
                        </button>
                    </div>
                    
                    <div x-show="createModal.formData.ports.length === 0" class="text-slate-500 text-sm italic">
                        No port mappings configured. Click "Add Port" to expose ports.
                    </div>
                    
                    <div class="space-y-2">
                        <template x-for="(port, index) in createModal.formData.ports" :key="index">
                            <div class="space-y-1">
                                <div class="flex items-center space-x-2">
                                    <input type="number"
                                           x-model="port.container"
                                           min="1"
                                           max="65535"
                                           placeholder="80"
                                           :class="{'border-red-500': createModal.errors['port_' + index]}"
                                           class="w-24 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <select x-model="port.protocol"
                                            :class="{'border-red-500': createModal.errors['port_' + index]}"
                                            class="w-20 px-2 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                        <option value="tcp">TCP</option>
                                        <option value="udp">UDP</option>
                                    </select>
                                    <span class="text-slate-400">‚Üí</span>
                                    <input type="number"
                                           x-model="port.host"
                                           min="1"
                                           max="65535"
                                           placeholder="8080"
                                           :class="{'border-red-500': createModal.errors['port_' + index]}"
                                           class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <button type="button"
                                            @click="removePort(index)"
                                            class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition">
                                        Remove
                                    </button>
                                </div>
                                <p x-show="createModal.errors['port_' + index]" class="text-xs text-red-400 ml-1" x-text="createModal.errors['port_' + index]"></p>
                            </div>
                        </template>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">üí° Container port ‚Üí Host port (e.g., 80/TCP ‚Üí 8080)</p>
                </div>
                
                <!-- Volume Mounts Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-white">Volume Mounts</h4>
                            <p class="text-xs text-slate-400 mt-1">Persist data or mount host directories</p>
                        </div>
                        <button type="button" 
                                @click="addVolume()"
                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition">
                            + Add Volume
                        </button>
                    </div>
                    
                    <div x-show="createModal.formData.volumes.length === 0" class="text-slate-500 text-sm italic">
                        No volume mounts configured. Click "Add Volume" to mount volumes.
                    </div>
                    
                    <div class="space-y-2">
                        <template x-for="(volume, index) in createModal.formData.volumes" :key="index">
                            <div class="space-y-1">
                                <div class="flex items-center space-x-2">
                                    <input type="text"
                                           x-model="volume.host"
                                           placeholder="/host/path"
                                           :class="{'border-red-500': createModal.errors['volume_' + index]}"
                                           class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <span class="text-slate-400">‚Üí</span>
                                    <input type="text"
                                           x-model="volume.container"
                                           placeholder="/container/path"
                                           :class="{'border-red-500': createModal.errors['volume_' + index]}"
                                           class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <select x-model="volume.mode"
                                            class="px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                        <option value="rw">Read-Write</option>
                                        <option value="ro">Read-Only</option>
                                    </select>
                                    <button type="button"
                                            @click="removeVolume(index)"
                                            class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition">
                                        Remove
                                    </button>
                                </div>
                                <p x-show="createModal.errors['volume_' + index]" class="text-xs text-red-400 ml-1" x-text="createModal.errors['volume_' + index]"></p>
                            </div>
                        </template>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">üí° Format: /host/path ‚Üí /container/path with mode (rw = read-write, ro = read-only)</p>
                </div>
                
                <!-- Environment Variables Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-white">Environment Variables</h4>
                            <p class="text-xs text-slate-400 mt-1">Pass configuration to the container</p>
                        </div>
                        <button type="button" 
                                @click="addEnvVar()"
                                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition">
                            + Add Variable
                        </button>
                    </div>
                    
                    <div x-show="createModal.formData.env_vars.length === 0" class="text-slate-500 text-sm italic">
                        No environment variables configured. Click "Add Variable" to add variables.
                    </div>
                    
                    <div class="space-y-2">
                        <template x-for="(envVar, index) in createModal.formData.env_vars" :key="index">
                            <div class="space-y-1">
                                <div class="flex items-center space-x-2">
                                    <input type="text"
                                           x-model="envVar.key"
                                           placeholder="VARIABLE_NAME"
                                           :class="{'border-red-500': createModal.errors['env_' + index]}"
                                           class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <span class="text-slate-400">=</span>
                                    <input type="text"
                                           x-model="envVar.value"
                                           placeholder="value"
                                           :class="{'border-red-500': createModal.errors['env_' + index]}"
                                           class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <button type="button"
                                            @click="removeEnvVar(index)"
                                            class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm transition">
                                        Remove
                                    </button>
                                </div>
                                <p x-show="createModal.errors['env_' + index]" class="text-xs text-red-400 ml-1" x-text="createModal.errors['env_' + index]"></p>
                            </div>
                        </template>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">üí° Format: KEY=value (e.g., DATABASE_URL=postgresql://...)</p>
                </div>
                
                <!-- Advanced Options Section -->
                <div class="bg-slate-900 rounded-lg p-4 border border-slate-700">
                    <h4 class="text-lg font-semibold text-white mb-4">Advanced Options</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- CPU Limit -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                CPU Limit (cores)
                            </label>
                            <input type="number" 
                                   x-model="createModal.formData.cpu_limit"
                                   step="0.1"
                                   min="0.1"
                                   placeholder="1.0"
                                   class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Leave empty for unlimited (e.g., 1.5 = 1.5 CPU cores)</p>
                        </div>
                        
                        <!-- Memory Limit -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-1">
                                Memory Limit (MB)
                            </label>
                            <input type="number" 
                                   x-model="createModal.formData.memory_limit"
                                   min="4"
                                   placeholder="512"
                                   class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-slate-500 mt-1">Leave empty for unlimited (minimum 4 MB)</p>
                        </div>
                        
                        <!-- Auto-start Checkbox -->
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" 
                                   x-model="createModal.formData.auto_start"
                                   id="auto-start"
                                   class="w-4 h-4 bg-slate-800 border-slate-600 rounded focus:ring-2 focus:ring-blue-500">
                            <label for="auto-start" class="text-sm text-slate-300">
                                Auto-start container after creation
                            </label>
                        </div>
                        
                        <!-- Pull-if-missing Checkbox -->
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" 
                                   x-model="createModal.formData.pull_if_missing"
                                   id="pull-missing"
                                   class="w-4 h-4 bg-slate-800 border-slate-600 rounded focus:ring-2 focus:ring-blue-500">
                            <label for="pull-missing" class="text-sm text-slate-300">
                                Pull image if not found locally
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-slate-700">
                    <button type="button" 
                            @click="closeCreateModal()"
                            :disabled="createModal.loading"
                            class="px-6 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-md transition">
                        Cancel
                    </button>
                    <button type="submit" 
                            :disabled="createModal.loading"
                            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed text-white rounded-md transition font-medium">
                        <span x-show="!createModal.loading">Create Container</span>
                        <span x-show="createModal.loading">Creating...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header with Hardware Stats -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 space-y-4 md:space-y-0">
            <div>
                <h2 class="text-3xl font-bold text-white">Containers</h2>
                <p class="text-slate-400 mt-1">Manage your Docker containers</p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Hardware Limits Display -->
                <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                    <div class="text-sm text-slate-400">Containers</div>
                    <div class="text-lg font-bold text-white">
                        <span x-text="containers.length"></span> / <span x-text="hardwareProfile.max_containers || '--'"></span>
                    </div>
                    <div class="text-xs text-slate-500" x-text="hardwareProfile.profile_name || 'Loading...'"></div>
                </div>

                <!-- Create Button -->
                <button @click="openCreateModal()"
                        :disabled="containers.length >= (hardwareProfile.max_containers || 999)"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed"
                        :title="containers.length >= (hardwareProfile.max_containers || 999) ? 'Hardware limit reached' : 'Create new container'">
                    <span class="mr-2">+</span> Create Container
                </button>
            </div>
        </div>

        <!-- FEATURE-005: Show All Containers Toggle -->
        <div class="mb-4 flex items-center gap-2">
            <label class="flex items-center gap-2 text-sm text-slate-300 cursor-pointer hover:text-white">
                <input type="checkbox"
                       x-model="showAllContainers"
                       @change="loadContainers()"
                       class="w-4 h-4 rounded border-slate-600 bg-slate-700 text-blue-600 focus:ring-2 focus:ring-blue-500 cursor-pointer">
                <span>Show all Docker containers (including external & DockerMate)</span>
            </label>
            <span class="text-xs text-slate-500" x-show="showAllContainers">
                (External containers can't be managed - no action buttons)
            </span>
        </div>

        <!-- Filters -->
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-4">
                    <h3 class="text-lg font-semibold text-white">Filters</h3>
                    <label x-show="filteredContainers.length > 0" class="flex items-center gap-2 text-sm text-slate-300 cursor-pointer hover:text-white">
                        <input type="checkbox"
                               x-model="selectAll"
                               @change="toggleSelectAll()"
                               class="w-4 h-4 rounded border-slate-600 bg-slate-700 text-blue-600 focus:ring-2 focus:ring-blue-500 cursor-pointer">
                        <span>Select All (<span x-text="filteredContainers.filter(c => c.managed !== false).length"></span> managed)</span>
                    </label>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-400">
                        Showing <span class="text-blue-400 font-semibold" x-text="filteredContainers.length"></span>
                        of <span x-text="containers.length"></span> containers
                    </span>
                    <button @click="clearFilters()"
                            x-show="filters.search || filters.status !== 'all' || filters.environment !== 'all' || filters.image !== 'all'"
                            class="text-sm text-blue-400 hover:text-blue-300 underline">
                        Clear all
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Search -->
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Search</label>
                    <input type="text"
                           x-model="filters.search"
                           @input="applyFilters()"
                           placeholder="Name or image..."
                           class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white placeholder-slate-500 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Status</label>
                    <select x-model="filters.status"
                            @change="applyFilters()"
                            class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Statuses</option>
                        <option value="running">Running</option>
                        <option value="exited">Stopped</option>
                        <option value="paused">Paused</option>
                        <option value="created">Created</option>
                    </select>
                </div>

                <!-- Environment Filter -->
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Environment</label>
                    <select x-model="filters.environment"
                            @change="applyFilters()"
                            class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Environments</option>
                        <option value="DEV">Development</option>
                        <option value="STG">Staging</option>
                        <option value="PROD">Production</option>
                    </select>
                </div>

                <!-- Image Filter -->
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Image</label>
                    <select x-model="filters.image"
                            @change="applyFilters()"
                            class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Images</option>
                        <template x-for="image in availableImages" :key="image">
                            <option :value="image" x-text="image"></option>
                        </template>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Loading State -->
        <div x-show="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            <p class="text-slate-400 mt-4">Loading containers...</p>
        </div>
        
        <!-- Empty State -->
        <div x-show="!loading && filteredContainers.length === 0 && containers.length === 0" 
             class="text-center py-12 bg-slate-800 rounded-lg border border-slate-700">
            <p class="text-slate-400 text-lg">No containers found</p>
            <p class="text-slate-500 mt-2">Click "Create Container" to get started</p>
        </div>
        
        <!-- No Results from Filters -->
        <div x-show="!loading && filteredContainers.length === 0 && containers.length > 0"
             class="text-center py-12 bg-slate-800 rounded-lg border border-slate-700">
            <p class="text-slate-400 text-lg">No containers match your filters</p>
            <p class="text-slate-500 mt-2">Try adjusting your search or filter criteria</p>
        </div>

        <!-- Bulk Actions Toolbar -->
        <div x-show="selectedContainers.length > 0 && !loading"
             class="bg-blue-900 border border-blue-700 rounded-lg p-4 mb-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <span class="text-white font-medium">
                    <span x-text="selectedContainers.length"></span> container(s) selected
                </span>
                <button @click="selectedContainers = []; selectAll = false"
                        class="text-blue-300 hover:text-blue-100 text-sm underline">
                    Clear selection
                </button>
            </div>
            <div class="flex items-center space-x-2">
                <button @click="showBulkConfirmation('start')"
                        class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition text-sm font-medium">
                    ‚ñ∂ Start All
                </button>
                <button @click="showBulkConfirmation('stop')"
                        class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md transition text-sm font-medium">
                    ‚è∏ Stop All
                </button>
                <button @click="showBulkConfirmation('restart')"
                        class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition text-sm font-medium">
                    üîÑ Restart All
                </button>
                <button @click="showBulkConfirmation('delete')"
                        class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition text-sm font-medium">
                    üóë Delete All
                </button>
            </div>
        </div>

        <!-- Containers Grid -->
        <div x-show="!loading && filteredContainers.length > 0" class="space-y-4">
            <template x-for="container in filteredContainers" :key="container.name">
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-6 hover:border-slate-600 transition"
                     :class="{'ring-2 ring-blue-500': selectedContainers.includes(container.name)}">
                    <div class="flex justify-between items-start mb-4">
                        <!-- Selection Checkbox -->
                        <div class="flex items-start space-x-3 flex-1">
                            <input type="checkbox"
                                   :checked="selectedContainers.includes(container.name)"
                                   @change="toggleSelect(container.name)"
                                   :disabled="container.managed === false"
                                   class="mt-1 w-5 h-5 rounded border-slate-600 bg-slate-700 text-blue-600 focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                                   :class="container.managed === false ? 'cursor-not-allowed' : 'cursor-pointer'"
                                   :title="container.managed === false ? 'External containers cannot be selected for bulk operations' : 'Select container'">
                            <!-- Container Info -->
                            <div class="flex-1">
                                <div class="flex items-center space-x-3">
                                    <h3 class="text-xl font-semibold text-white" x-text="container.name"></h3>
                                <span :class="{
                                    'bg-green-900 text-green-300': container.state === 'running',
                                    'bg-red-900 text-red-300': container.state === 'exited',
                                    'bg-yellow-900 text-yellow-300': container.state === 'paused',
                                    'bg-gray-700 text-gray-300': !['running', 'exited', 'paused'].includes(container.state)
                                }" class="px-2 py-1 rounded text-xs font-medium uppercase" x-text="container.state"></span>
                                <span x-show="container.environment"
                                      :class="{
                                    'bg-green-900 text-green-300': container.environment === 'DEV',
                                    'bg-yellow-900 text-yellow-300': container.environment === 'STG',
                                    'bg-red-900 text-red-300': container.environment === 'PROD'
                                }" class="px-2 py-1 rounded text-xs font-medium" x-text="container.environment"></span>
                                <!-- FEATURE-005: Managed/External Badge -->
                                <span x-show="showAllContainers && container.managed === false"
                                      class="px-2 py-1 rounded text-xs font-medium bg-orange-900 text-orange-300"
                                      title="External container not managed by DockerMate">
                                    EXTERNAL
                                </span>
                                <span x-show="showAllContainers && container.managed === true"
                                      class="px-2 py-1 rounded text-xs font-medium bg-blue-900 text-blue-300"
                                      title="Managed by DockerMate">
                                    MANAGED
                                </span>
                            </div>
                                <div class="flex items-center gap-2 mt-1">
                                    <p class="text-slate-400 font-mono text-sm" x-text="container.image_name"></p>
                                    <span x-show="hasUpdate(container)"
                                          class="px-2 py-0.5 bg-yellow-900 text-yellow-300 rounded text-xs font-medium">
                                        UPDATE AVAILABLE
                                    </span>
                                </div>
                                <p class="text-slate-500 text-xs mt-1">
                                    Created: <span x-text="formatDate(container.created_at)"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Container Actions -->
                    <!-- FEATURE-005: Only show actions for managed containers -->
                    <div class="flex flex-wrap gap-2" x-show="container.managed !== false">
                        <!-- Start Button -->
                        <button x-show="container.state !== 'running'"
                                @click="performAction(container.name, 'start')"
                                :disabled="actionLoading[container.name]"
                                title="Start container (docker start)"
                                class="px-3 py-2 bg-green-600 hover:bg-green-700 disabled:bg-green-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">‚ñ∂ Start</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>

                        <!-- Stop Button -->
                        <button x-show="container.state === 'running'"
                                @click="performAction(container.name, 'stop')"
                                :disabled="actionLoading[container.name]"
                                title="Stop container (docker stop)"
                                class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 disabled:bg-yellow-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">‚è∏ Stop</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>

                        <!-- Restart Button -->
                        <button x-show="container.state === 'running'"
                                @click="performAction(container.name, 'restart')"
                                :disabled="actionLoading[container.name]"
                                title="Restart container (docker restart)"
                                class="px-3 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">üîÑ Restart</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>

                        <!-- Details Button -->
                        <button @click="showDetails(container)"
                                class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition text-sm font-medium">
                            ‚Ñπ Details
                        </button>

                        <!-- Logs Button -->
                        <button @click="openLogsModal(container.container_id, container.name)"
                                class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition text-sm font-medium"
                                title="View container logs (docker logs)">
                            üìú Logs
                        </button>

                        <!-- Sprint 3: Update Button (shown when image has update available) -->
                        <button x-show="hasUpdate(container)"
                                @click="updateContainer(container.name)"
                                :disabled="actionLoading[container.name]"
                                title="Pull latest image and recreate container"
                                class="px-3 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">‚¨Ü Update</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>

                        <!-- Sprint 3: Rollback Button ‚Äî disabled when no update history exists -->
                        <button @click="rollbackContainer(container.name)"
                                :disabled="actionLoading[container.name] || !container.rollback_available"
                                :title="container.rollback_available ? 'Rollback to previous image version' : 'No previous version to roll back to'"
                                class="px-3 py-2 bg-slate-600 hover:bg-slate-500 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">‚Ü© Rollback</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>

                        <!-- FEAT-013: Retag Button -->
                        <button @click="openRetagModal(container)"
                                :disabled="actionLoading[container.name]"
                                title="Change image tag and redeploy"
                                class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">üè∑ Retag</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>

                        <!-- Delete Button -->
                        <button @click="showDeleteConfirmation(container.name, container.name)"
                                :disabled="actionLoading[container.name]"
                                title="Delete container (docker rm)"
                                class="px-3 py-2 bg-red-600 hover:bg-red-700 disabled:bg-red-400 disabled:cursor-not-allowed text-white rounded-md transition text-sm font-medium">
                            <span x-show="!actionLoading[container.name]">üóë Delete</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>
                    </div>

                    <!-- FEAT-012: Import button for external containers -->
                    <div x-show="container.managed === false" class="mt-4 p-3 bg-orange-900/20 border border-orange-700 rounded text-sm text-orange-300 flex items-center justify-between">
                        <span>‚ÑπÔ∏è External container ‚Äî not managed by DockerMate.</span>
                        <button @click="importContainer(container)"
                                :disabled="actionLoading[container.name]"
                                title="Import this container into DockerMate (metadata only)"
                                class="ml-3 px-3 py-1 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed text-white rounded text-sm font-medium whitespace-nowrap transition">
                            <span x-show="!actionLoading[container.name]">‚¨á Import</span>
                            <span x-show="actionLoading[container.name]">‚è≥</span>
                        </button>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Auto-refresh Indicator -->
        <div x-show="!loading && containers.length > 0" class="mt-6 text-center">
            <p class="text-slate-500 text-sm">
                <span x-show="selectedContainers.length === 0">
                    üîÑ Auto-refreshing every 10 seconds | Last updated: <span x-text="lastUpdated"></span>
                </span>
                <span x-show="selectedContainers.length > 0" class="text-yellow-400">
                    ‚è∏ Auto-refresh paused (containers selected) | Last updated: <span x-text="lastUpdated"></span>
                </span>
            </p>
        </div>
    </main>
</div>

<script>
/**
 * Containers Page Alpine.js Component
 * 
 * Manages container list display, filtering, and actions (start/stop/restart/delete).
 * Implements hardware-aware container management with educational CLI equivalents.
 * 
 * Task 7 Addition: Container creation modal with comprehensive form validation.
 * 
 * Educational Notes:
 * - Container operations map to Docker CLI commands (shown in tooltips and details)
 * - Hardware limits enforced to prevent system overload
 * - Real-time sync with Docker daemon state
 */
function containersComponent() {
    return {
        // State management
        containers: [],
        filteredContainers: [],
        loading: false,
        lastUpdated: 'Never',
        pollInterval: null,
        hardwareProfile: {},
        runningCount: 0,
        actionLoading: {},

        // Bulk operations state
        selectedContainers: [],
        selectAll: false,
        bulkModal: {
            show: false,
            operation: '',
            operationLabel: '',
            loading: false,
            results: [],
            completed: false
        },
        
        // Filter state
        filters: {
            search: '',
            status: 'all',
            environment: 'all',
            image: 'all'
        },

        // Show all containers toggle (FEATURE-005)
        showAllContainers: true,

        // Sprint 3: map of "repository:tag" -> update_available (from images API)
        imagesUpdateMap: {},

        // Computed filter options (populated from containers)
        availableImages: [],
        
        // Toast notification state
        toast: {
            show: false,
            message: '',
            type: 'info'
        },
        
        // Health check polling state (Task 7 Fix - Issue 4)
        healthCheckPolling: {}, // { containerName: { intervalId, attempts, startTime } }
        
        // Delete modal state
        deleteModal: {
            show: false,
            containerId: null,
            containerName: '',
            isRunning: false,
            loading: false
        },
        
        // Details modal state
        detailsModal: {
            show: false,
            container: null
        },
        
        // Create modal state (Task 7)
        createModal: {
            show: false,
            loading: false,
            errors: {},
            errorMessage: '',
            networks: [],          // available networks for the dropdown
            formData: {
                name: '',
                image: '',
                environment: 'DEV',
                ports: [],
                volumes: [],
                env_vars: [],
                restart_policy: 'unless-stopped',
                cpu_limit: null,
                memory_limit: null,
                auto_start: true,
                pull_if_missing: true,
                network: ''
            }
        },

        // Logs viewer modal state
        logsModal: {
            show: false,
            loading: false,
            error: null,
            containerId: null,
            containerName: '',
            logs: '',
            filteredLogs: '',
            searchTerm: '',
            tail: '100',
            timestamps: 'false',
            autoRefresh: 'false',
            autoRefreshInterval: null,
            lineCount: 0,
            matchCount: 0,
            truncated: false,
            cliCommand: '',
            lastUpdated: null
        },

        // Retag modal state (FEAT-013)
        retagModal: {
            show: false,
            loading: false,
            container: null,
            currentImage: '',
            newTag: '',
            error: null
        },

        /**
         * Initialize component
         */
        async init() {
            this.loadFiltersFromURL();  // Load filters from URL first
            await Promise.all([
                this.loadHardwareProfile(),
                this.loadContainers(),
                this.loadImagesUpdateMap()
            ]);
            this.startPolling();
        },
        
        /**
         * Load hardware profile from API
         */
        async loadHardwareProfile() {
            try {
                const response = await fetch('/api/system/hardware');
                const data = await response.json();
                
                if (data.success) {
                    this.hardwareProfile = data.data;
                }
            } catch (error) {
                console.error('Failed to load hardware profile:', error);
            }
        },
        
        /**
         * Load containers from API
         * Educational: Equivalent to `docker ps -a`
         */
        async loadContainers() {
            this.loading = true;

            try {
                // FEATURE-005: Add show_all parameter to fetch all Docker containers
                const params = new URLSearchParams();
                params.append('all', 'true');  // Always include stopped containers
                params.append('show_all', this.showAllContainers);

                const response = await fetch(`/api/containers?${params}`);

                // TASK 7 FIX: Check HTTP status first
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // TASK 7 FIX: Force reactivity with spread
                    this.containers = [...(data.data || [])];

                    // UI_ISSUES FIX: Initialize actionLoading to false for each container
                    this.containers.forEach(container => {
                        this.actionLoading[container.name] = false;
                    });

                    this.runningCount = this.containers.filter(c => c.state === 'running').length;
                    this.updateAvailableImages();  // Populate image filter dropdown
                    this.applyFilters();
                    this.lastUpdated = new Date().toLocaleTimeString();
                } else {
                    this.showToast('Failed to load containers: ' + data.message, 'error');
                }
            } catch (error) {
                this.showToast('Failed to load containers: ' + error.message, 'error');
            } finally {
                this.loading = false;
            }
        },
        
        /**
         * Apply filters to container list
         */
        applyFilters() {
            this.filteredContainers = this.containers.filter(container => {
                const searchLower = this.filters.search.toLowerCase().trim();

                // Search filter - match whole words or word starts, not substrings within words
                let searchMatch = this.filters.search === '';
                if (!searchMatch && searchLower) {
                    const nameText = (container.name || '').toLowerCase();
                    const imageText = (container.image_name || '').toLowerCase();

                    // Split text into words (by spaces, hyphens, colons, slashes)
                    const nameWords = nameText.split(/[\s\-:\/]+/);
                    const imageWords = imageText.split(/[\s\-:\/]+/);

                    // Match if any word starts with the search term OR exact substring match in name
                    searchMatch = nameWords.some(word => word.startsWith(searchLower)) ||
                                  imageWords.some(word => word.startsWith(searchLower)) ||
                                  nameText === searchLower ||  // Exact match
                                  nameText.includes(' ' + searchLower); // Word in the middle
                }

                // Status filter
                const statusMatch = this.filters.status === 'all' || container.state === this.filters.status;

                // Environment filter
                const envMatch = this.filters.environment === 'all' || container.environment === this.filters.environment;

                // Image filter
                const imageMatch = this.filters.image === 'all' || container.image_name === this.filters.image;

                return searchMatch && statusMatch && envMatch && imageMatch;
            });

            // Update URL with current filters
            this.updateURLParams();
        },

        /**
         * Clear all filters
         */
        clearFilters() {
            this.filters = {
                search: '',
                status: 'all',
                environment: 'all',
                image: 'all'
            };
            this.applyFilters();
        },

        /**
         * Extract unique images from containers for filter dropdown
         */
        updateAvailableImages() {
            const uniqueImages = [...new Set(this.containers.map(c => c.image_name))];
            this.availableImages = uniqueImages.sort();
        },

        /**
         * Update URL query parameters with current filters
         */
        updateURLParams() {
            const params = new URLSearchParams();

            if (this.filters.search) params.set('search', this.filters.search);
            if (this.filters.status !== 'all') params.set('status', this.filters.status);
            if (this.filters.environment !== 'all') params.set('env', this.filters.environment);
            if (this.filters.image !== 'all') params.set('image', this.filters.image);

            const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
            window.history.replaceState({}, '', newURL);
        },

        /**
         * Load filters from URL query parameters
         */
        loadFiltersFromURL() {
            const params = new URLSearchParams(window.location.search);

            this.filters.search = params.get('search') || '';
            this.filters.status = params.get('status') || 'all';
            this.filters.environment = params.get('env') || 'all';
            this.filters.image = params.get('image') || 'all';
        },
        
        /**
         * Perform container action (start/stop/restart)
         * Educational: Maps to Docker CLI commands
         */
        async performAction(containerId, action) {
            // Set loading state
            this.actionLoading[containerId] = true;

            try {
                const response = await fetch(`/api/containers/${containerId}/${action}`, {
                    method: 'POST'
                });

                // TASK 7 FIX: Check HTTP status
                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    throw new Error(data.error || `Failed to ${action} container`);
                }

                const data = await response.json();

                if (data.success) {
                    this.showToast(`Container ${action} successful`, 'success');
                    await this.loadContainers();
                } else {
                    this.showToast(`Failed to ${action} container: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error(`performAction error (${action} ${containerId}):`, error);
                this.showToast(`Failed to ${action} container: ${error.message}`, 'error');
            } finally {
                // Clear loading state - use Vue.delete equivalent for reactivity
                this.actionLoading[containerId] = false;
            }
        },
        
        /**
         * Start health check polling for a container with exponential backoff
         * Polling schedule: 3s, 5s, 8s, 12s, 15s, 20s... (max 10 attempts)
         */
        startHealthCheckPolling(containerName) {
            if (this.healthCheckPolling[containerName]) return;

            const maxAttempts = 10;
            let attempts = 0;
            const startTime = Date.now();

            // Exponential backoff delays (in milliseconds)
            const getNextDelay = (attemptNum) => {
                const delays = [3000, 5000, 8000, 12000, 15000, 20000, 25000, 30000, 35000, 40000];
                return delays[attemptNum] || 40000;  // Cap at 40s
            };

            const checkHealth = async () => {
                attempts++;
                try {
                    const response = await fetch(`/api/containers/${containerName}/health`);
                    if (!response.ok) {
                        this.stopHealthCheckPolling(containerName);
                        return;
                    }

                    const data = await response.json();
                    if (data.success) {
                        const health = data.data;
                        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

                        if (health.healthy && health.running) {
                            this.showToast(`‚úÖ Container "${containerName}" is healthy (${elapsed}s)`, 'success');
                            this.stopHealthCheckPolling(containerName);
                            await this.loadContainers();
                            return;
                        }

                        if (!health.running || (health.exit_code && health.exit_code !== 0)) {
                            const errorMsg = health.error || `Exited with code ${health.exit_code}`;
                            this.showToast(`‚ùå Container "${containerName}" crashed: ${errorMsg}`, 'error');
                            this.stopHealthCheckPolling(containerName);
                            await this.loadContainers();
                            return;
                        }

                        if (attempts >= maxAttempts) {
                            this.showToast(`‚ö†Ô∏è Container "${containerName}" health check timeout`, 'warning');
                            this.stopHealthCheckPolling(containerName);
                            await this.loadContainers();
                            return;
                        }

                        // Schedule next check with exponential backoff
                        const nextDelay = getNextDelay(attempts);
                        const timeoutId = setTimeout(checkHealth, nextDelay);
                        this.healthCheckPolling[containerName].timeoutId = timeoutId;
                    }
                } catch (error) {
                    if (attempts >= maxAttempts) {
                        this.stopHealthCheckPolling(containerName);
                    } else {
                        // Retry with exponential backoff
                        const nextDelay = getNextDelay(attempts);
                        const timeoutId = setTimeout(checkHealth, nextDelay);
                        this.healthCheckPolling[containerName].timeoutId = timeoutId;
                    }
                }
            };

            // Store polling state and start first check after initial delay
            this.healthCheckPolling[containerName] = { attempts, startTime, timeoutId: null };
            this.showToast(`üîç Monitoring "${containerName}" health...`, 'info');

            // Start first check after 3 seconds
            const timeoutId = setTimeout(checkHealth, 3000);
            this.healthCheckPolling[containerName].timeoutId = timeoutId;
        },
        
        stopHealthCheckPolling(containerName) {
            const polling = this.healthCheckPolling[containerName];
            if (polling) {
                if (polling.timeoutId) {
                    clearTimeout(polling.timeoutId);
                }
                delete this.healthCheckPolling[containerName];
            }
        },
        
        stopAllHealthCheckPolling() {
            for (const name in this.healthCheckPolling) {
                this.stopHealthCheckPolling(name);
            }
        },
        
        /**
         * Show delete confirmation modal
         */
        showDeleteConfirmation(containerId, containerName) {
            const container = this.containers.find(c => c.name === containerId);
            this.deleteModal.containerId = containerId;
            this.deleteModal.containerName = containerName;
            this.deleteModal.isRunning = container && container.state === 'running';
            this.deleteModal.show = true;
        },
        
        /**
         * Close delete modal
         */
        closeDeleteModal() {
            this.deleteModal.show = false;
            this.deleteModal.containerId = null;
            this.deleteModal.containerName = '';
            this.deleteModal.isRunning = false;
        },
        
        /**
         * Confirm and execute delete
         * Educational: Equivalent to `docker rm -f <container>`
         */
        async confirmDelete() {
            this.deleteModal.loading = true;
            
            try {
                const response = await fetch(`/api/containers/${this.deleteModal.containerId}?force=true`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    this.showToast('Container deleted successfully', 'success');
                    this.closeDeleteModal();
                    await this.loadContainers();
                } else {
                    this.showToast('Failed to delete container: ' + data.message, 'error');
                }
            } catch (error) {
                this.showToast('Failed to delete container: ' + error.message, 'error');
            } finally {
                this.deleteModal.loading = false;
            }
        },
        
        /**
         * Show container details modal
         */
        async showDetails(container) {
            // Show modal immediately with list data, then enrich with full
            // detail (env_vars, volumes, cpu/memory limits) for managed containers.
            this.detailsModal.container = container;
            this.detailsModal.show = true;

            if (container.managed) {
                try {
                    const r = await fetch(`/api/containers/${container.container_id}`);
                    if (r.ok) {
                        const d = await r.json();
                        if (d.success) this.detailsModal.container = d.data;
                    }
                } catch (e) {
                    console.error('showDetails fetch:', e);
                }
            }
        },
        
        /**
         * Close details modal
         */
        closeDetailsModal() {
            this.detailsModal.show = false;
            this.detailsModal.container = null;
        },
        
        /**
         * Task 7: Open create container modal
         */
        openCreateModal() {
            // Reset form data
            this.createModal.formData = {
                name: '',
                image: '',
                environment: 'DEV',
                ports: [],
                volumes: [],
                env_vars: [],
                restart_policy: 'unless-stopped',
                cpu_limit: null,
                memory_limit: null,
                auto_start: true,
                pull_if_missing: true,
                network: ''
            };
            this.createModal.errors = {};
            this.createModal.errorMessage = '';
            this.createModal.show = true;
            // Load available networks for the dropdown
            this.loadNetworksForCreate();
        },

        async loadNetworksForCreate() {
            try {
                const res = await fetch('/api/networks');
                const data = await res.json();
                if (data.success) {
                    this.createModal.networks = data.data.filter(n => n.driver === 'bridge');
                }
            } catch (e) { /* non-fatal */ }
        },
        
        /**
         * Task 7: Close create modal
         */
        closeCreateModal() {
            this.createModal.show = false;
        },
        
        /**
         * Task 7: Add port mapping entry
         */
        addPort() {
            this.createModal.formData.ports.push({
                container: '',
                host: '',
                protocol: 'tcp'  // Default to TCP
            });
        },
        
        /**
         * Task 7: Remove port mapping entry
         */
        removePort(index) {
            this.createModal.formData.ports.splice(index, 1);
        },
        
        /**
         * Task 7: Add volume mount entry
         */
        addVolume() {
            this.createModal.formData.volumes.push({
                host: '',
                container: '',
                mode: 'rw'
            });
        },
        
        /**
         * Task 7: Remove volume mount entry
         */
        removeVolume(index) {
            this.createModal.formData.volumes.splice(index, 1);
        },
        
        /**
         * Task 7: Add environment variable entry
         */
        addEnvVar() {
            this.createModal.formData.env_vars.push({
                key: '',
                value: ''
            });
        },
        
        /**
         * Task 7: Remove environment variable entry
         */
        removeEnvVar(index) {
            this.createModal.formData.env_vars.splice(index, 1);
        },
        
        /**
         * Task 7: Validate form client-side
         */
        validateForm() {
            const errors = {};
            const formData = this.createModal.formData;
            
            // Validate required fields
            if (!formData.name || !formData.name.trim()) {
                errors.name = 'Container name is required';
            } else if (!/^[a-zA-Z0-9_-]+$/.test(formData.name)) {
                errors.name = 'Name must contain only alphanumeric characters, hyphens, and underscores';
            }
            
            if (!formData.image || !formData.image.trim()) {
                errors.image = 'Image name is required';
            }
            
            // Validate port mappings - only check if at least one field is filled
            formData.ports.forEach((port, index) => {
                const hasAnyValue = port.container || port.host;
                if (hasAnyValue) {
                    if (!port.container) {
                        errors[`port_${index}`] = 'Container port is required';
                    } else if (port.container < 1 || port.container > 65535) {
                        errors[`port_${index}`] = 'Container port must be between 1 and 65535';
                    }

                    if (!port.host) {
                        errors[`port_${index}`] = 'Host port is required';
                    } else if (port.host < 1 || port.host > 65535) {
                        errors[`port_${index}`] = 'Host port must be between 1 and 65535';
                    }
                }
            });
            
            // Validate volumes - only check if at least one field is filled
            formData.volumes.forEach((volume, index) => {
                const hasAnyValue = volume.host || volume.container;
                if (hasAnyValue) {
                    if (!volume.host) {
                        errors[`volume_${index}`] = 'Host path is required';
                    }
                    if (!volume.container) {
                        errors[`volume_${index}`] = 'Container path is required';
                    }
                }
            });
            
            // Validate environment variables - only check if at least one field is filled
            formData.env_vars.forEach((envVar, index) => {
                const hasAnyValue = envVar.key || envVar.value;
                if (hasAnyValue) {
                    if (!envVar.key) {
                        errors[`env_${index}`] = 'Variable name is required';
                    }
                    if (!envVar.value) {
                        errors[`env_${index}`] = 'Variable value is required';
                    }
                }
            });
            
            // Validate resource limits
            if (formData.cpu_limit !== null && formData.cpu_limit !== '' && formData.cpu_limit <= 0) {
                errors.cpu_limit = 'CPU limit must be greater than 0';
            }
            
            if (formData.memory_limit !== null && formData.memory_limit !== '' && formData.memory_limit < 4) {
                errors.memory_limit = 'Memory limit must be at least 4 MB';
            }
            
            this.createModal.errors = errors;
            
            // Build detailed error message for banner
            if (Object.keys(errors).length > 0) {
                const errorFields = [];
                if (errors.name) errorFields.push('Container Name');
                if (errors.image) errorFields.push('Image Name');
                
                // Check for port errors
                const portErrors = Object.keys(errors).filter(k => k.startsWith('port_'));
                if (portErrors.length > 0) errorFields.push('Port Mappings');
                
                // Check for volume errors
                const volumeErrors = Object.keys(errors).filter(k => k.startsWith('volume_'));
                if (volumeErrors.length > 0) errorFields.push('Volume Mounts');
                
                // Check for env var errors
                const envErrors = Object.keys(errors).filter(k => k.startsWith('env_'));
                if (envErrors.length > 0) errorFields.push('Environment Variables');
                
                if (errors.cpu_limit) errorFields.push('CPU Limit');
                if (errors.memory_limit) errorFields.push('Memory Limit');
                
                this.createModal.errorMessage = `Please fix the following: ${errorFields.join(', ')}`;
            }
            
            return Object.keys(errors).length === 0;
        },
        
        /**
         * Task 7: Submit create form
         * Educational: Equivalent to `docker run` with all specified options
         */
        async submitCreateForm() {
            // Reset previous errors
            this.createModal.errorMessage = '';
            this.createModal.errors = {};
            
            // Validate form
            if (!this.validateForm()) {
                this.createModal.errorMessage = 'Please fix the errors in the form';
                return;
            }
            
            this.createModal.loading = true;
            
            try {
                // Transform form data to API format
                const requestData = {
                    name: this.createModal.formData.name.trim(),
                    image: this.createModal.formData.image.trim(),
                    environment: this.createModal.formData.environment,
                    restart_policy: this.createModal.formData.restart_policy,
                    auto_start: this.createModal.formData.auto_start,
                    pull_if_missing: this.createModal.formData.pull_if_missing
                };

                // Network selection
                if (this.createModal.formData.network) {
                    requestData.network = this.createModal.formData.network;
                }

                // Transform ports array to API format
                if (this.createModal.formData.ports.length > 0) {
                    requestData.ports = {};
                    this.createModal.formData.ports.forEach(port => {
                        if (port.container && port.host) {
                            // Combine port number with protocol (e.g., "80/tcp")
                            const portKey = `${port.container}/${port.protocol || 'tcp'}`;
                            requestData.ports[portKey] = parseInt(port.host);
                        }
                    });
                }
                
                // Transform volumes array to API format
                if (this.createModal.formData.volumes.length > 0) {
                    requestData.volumes = {};
                    this.createModal.formData.volumes.forEach(volume => {
                        if (volume.host && volume.container) {
                            requestData.volumes[volume.host] = {
                                bind: volume.container,
                                mode: volume.mode
                            };
                        }
                    });
                }
                
                // Transform env vars array to API format
                if (this.createModal.formData.env_vars.length > 0) {
                    requestData.env_vars = {};
                    this.createModal.formData.env_vars.forEach(envVar => {
                        if (envVar.key && envVar.value) {
                            requestData.env_vars[envVar.key] = envVar.value;
                        }
                    });
                }
                
                // Add resource limits if specified
                if (this.createModal.formData.cpu_limit) {
                    requestData.cpu_limit = parseFloat(this.createModal.formData.cpu_limit);
                }

                if (this.createModal.formData.memory_limit) {
                    // Convert MB to bytes for API (backend expects bytes per API spec)
                    // User enters MB in form ‚Üí API receives bytes ‚Üí Docker receives bytes
                    const MB_TO_BYTES = 1024 * 1024;
                    requestData.memory_limit = parseInt(this.createModal.formData.memory_limit) * MB_TO_BYTES;
                }
                
                // Make API request
                const response = await fetch('/api/containers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                // TASK 7 FIX: Check HTTP status BEFORE parsing
                if (!response.ok) {
                    const data = await response.json();
                    this.createModal.errorMessage = data.error || 'Failed to create container';
                    this.createModal.loading = false;
                    return;  // STOP processing
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const containerName = this.createModal.formData.name;
                    this.showToast(`Container "${containerName}" created successfully`, 'success');
                    this.closeCreateModal();
                    await this.loadContainers();
                    
                    // TASK 7 FIX: Start health check polling if auto-start enabled
                    // Polling starts with 3s delay and uses exponential backoff
                    if (this.createModal.formData.auto_start) {
                        this.startHealthCheckPolling(containerName);
                    }
                } else {
                    // Handle API validation errors
                    if (data.error_type === 'validation_error') {
                        this.createModal.errorMessage = data.message;
                    } else if (data.error_type === 'docker_error') {
                        this.createModal.errorMessage = `Docker error: ${data.message}`;
                    } else {
                        this.createModal.errorMessage = data.message;
                    }
                }
            } catch (error) {
                this.createModal.errorMessage = `Failed to create container: ${error.message}`;
            } finally {
                this.createModal.loading = false;
            }
        },
        
        /**
         * Generate Docker CLI command equivalent
         * Educational: Shows how the container can be recreated via CLI
         */
        generateDockerCommand(container) {
            if (!container) return '';
            
            let cmd = 'docker run -d';
            
            // Add name
            cmd += ` \\\n  --name ${container.name}`;
            
            // Add restart policy
            if (container.restart_policy) {
                cmd += ` \\\n  --restart ${container.restart_policy}`;
            }
            
            // Add ports
            if (container.ports && container.ports.length > 0) {
                container.ports.forEach(port => {
                    // Format: host:container/protocol
                    const portStr = `${port.host}:${port.container}/${port.protocol || 'tcp'}`;
                    cmd += ` \\\n  -p ${portStr}`;
                });
            }

            // Add CPU limit
            if (container.cpu_limit) {
                cmd += ` \\\n  --cpus="${container.cpu_limit}"`;
            }

            // Add memory limit
            if (container.memory_limit) {
                const memoryMB = Math.round(container.memory_limit / (1024 * 1024));
                cmd += ` \\\n  --memory="${memoryMB}m"`;
            }

            // Add environment variables
            if (container.env_vars && container.env_vars.length > 0) {
                container.env_vars.forEach(env => {
                    cmd += ` \\\n  -e "${env}"`;
                });
            }

            // Add volumes
            if (container.volumes && container.volumes.length > 0) {
                container.volumes.forEach(volume => {
                    cmd += ` \\\n  -v ${volume.source}:${volume.destination}:${volume.mode}`;
                });
            }

            // Add labels
            if (container.labels) {
                Object.entries(container.labels).forEach(([key, value]) => {
                    cmd += ` \\\n  --label ${key}=${value}`;
                });
            }

            // Add image
            cmd += ` \\\n  ${container.image_name}`;

            return cmd;
        },

        /**
         * Open logs viewer modal
         */
        openLogsModal(containerId, containerName) {
            this.logsModal.containerId = containerId;
            this.logsModal.containerName = containerName;
            this.logsModal.show = true;
            this.logsModal.error = null;
            this.logsModal.searchTerm = '';
            this.fetchLogs();
        },

        /**
         * Close logs viewer modal
         */
        closeLogsModal() {
            this.logsModal.show = false;
            if (this.logsModal.autoRefreshInterval) {
                clearInterval(this.logsModal.autoRefreshInterval);
                this.logsModal.autoRefreshInterval = null;
            }
        },

        /**
         * Fetch container logs from API
         */
        async fetchLogs() {
            this.logsModal.loading = true;
            this.logsModal.error = null;

            try {
                const params = new URLSearchParams({
                    tail: this.logsModal.tail,
                    timestamps: this.logsModal.timestamps
                });

                const response = await fetch(`/api/containers/${this.logsModal.containerId}/logs?${params}`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    this.logsModal.logs = data.data.logs;
                    this.logsModal.filteredLogs = data.data.logs;
                    this.logsModal.lineCount = data.data.line_count;
                    this.logsModal.truncated = data.data.truncated;
                    this.logsModal.cliCommand = data.data.cli_command;
                    this.logsModal.lastUpdated = new Date().toLocaleTimeString();
                    this.filterLogs(); // Apply search filter if any
                } else {
                    this.logsModal.error = data.error || 'Failed to fetch logs';
                }
            } catch (error) {
                this.logsModal.error = error.message;
            } finally {
                this.logsModal.loading = false;
            }
        },

        /**
         * Filter logs based on search term
         */
        filterLogs() {
            if (!this.logsModal.searchTerm || !this.logsModal.logs) {
                this.logsModal.filteredLogs = this.logsModal.logs;
                this.logsModal.matchCount = 0;
                return;
            }

            const searchLower = this.logsModal.searchTerm.toLowerCase();
            const lines = this.logsModal.logs.split('\n');
            const matchedLines = lines.filter(line => line.toLowerCase().includes(searchLower));

            this.logsModal.filteredLogs = matchedLines.join('\n');
            this.logsModal.matchCount = matchedLines.length;
        },

        /**
         * Download logs to file
         */
        downloadLogs() {
            const logs = this.logsModal.filteredLogs || this.logsModal.logs;
            if (!logs) {
                this.showToast('No logs to download', 'warning');
                return;
            }

            const blob = new Blob([logs], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            a.download = `${this.logsModal.containerName}_${timestamp}.log`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            this.showToast('Logs downloaded successfully', 'success');
        },

        /**
         * Toggle auto-refresh for logs
         */
        toggleAutoRefresh() {
            // Clear existing interval
            if (this.logsModal.autoRefreshInterval) {
                clearInterval(this.logsModal.autoRefreshInterval);
                this.logsModal.autoRefreshInterval = null;
            }

            // Set new interval if enabled
            if (this.logsModal.autoRefresh !== 'false') {
                const intervalSeconds = parseInt(this.logsModal.autoRefresh);
                this.logsModal.autoRefreshInterval = setInterval(() => {
                    this.fetchLogs();
                }, intervalSeconds * 1000);
            }
        },

        /**
         * Copy CLI command to clipboard
         */
        async copyCliCommand() {
            try {
                await navigator.clipboard.writeText(this.logsModal.cliCommand);
                this.showToast('CLI command copied to clipboard', 'success');
            } catch (error) {
                this.showToast('Failed to copy to clipboard', 'error');
            }
        },

        /**
         * Format date for display
         */
        formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString();
        },
        
        /**
         * Sprint 3: Load images and build a map of image name -> update_available
         */
        async loadImagesUpdateMap() {
            try {
                const response = await fetch('/api/images');
                if (!response.ok) return;
                const data = await response.json();
                if (data.success) {
                    const map = {};
                    data.data.forEach(img => {
                        const key = (img.repository || '') + ':' + (img.tag || '');
                        map[key] = img.update_available || false;
                    });
                    this.imagesUpdateMap = map;
                }
            } catch (e) { console.error('loadImagesUpdateMap:', e); }
        },

        /**
         * Sprint 3: Check if a container's image has an update available
         */
        hasUpdate(container) {
            return this.imagesUpdateMap[container.image_name] === true;
        },

        /**
         * Sprint 3: Update a container's image to the latest version
         */
        async updateContainer(containerName) {
            this.actionLoading[containerName] = true;
            try {
                const response = await fetch(`/api/containers/${containerName}/update`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    this.showToast(`Container "${containerName}" updated successfully`, 'success');
                    await this.loadContainers();
                    await this.loadImagesUpdateMap();
                } else {
                    this.showToast(`Update failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                this.showToast(`Update failed: ${error.message}`, 'error');
            } finally {
                this.actionLoading[containerName] = false;
            }
        },

        /**
         * Sprint 3: Rollback a container to its previous image
         */
        async rollbackContainer(containerName) {
            this.actionLoading[containerName] = true;
            try {
                const response = await fetch(`/api/containers/${containerName}/rollback`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    this.showToast(`Container "${containerName}" rolled back to ${data.data?.rolled_back_to || 'previous image'}`, 'success');
                    await this.loadContainers();
                    await this.loadImagesUpdateMap();
                } else {
                    this.showToast(`Rollback failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                this.showToast(`Rollback failed: ${error.message}`, 'error');
            } finally {
                this.actionLoading[containerName] = false;
            }
        },

        /**
         * FEAT-012: Import an external container into DockerMate
         */
        async importContainer(container) {
            this.actionLoading[container.name] = true;
            try {
                const response = await fetch(`/api/containers/${container.container_id}/import`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    this.showToast(data.message || `Container "${container.name}" imported successfully`, 'success');
                    await this.loadContainers();
                } else {
                    this.showToast(`Import failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                this.showToast(`Import failed: ${error.message}`, 'error');
            } finally {
                this.actionLoading[container.name] = false;
            }
        },

        /**
         * FEAT-013: Open the retag modal for a managed container
         */
        openRetagModal(container) {
            this.retagModal.container = container;
            this.retagModal.currentImage = container.image_name || '';
            this.retagModal.newTag = '';
            this.retagModal.error = null;
            this.retagModal.loading = false;
            this.retagModal.show = true;
        },

        /**
         * FEAT-013: Submit the retag request
         */
        async submitRetag() {
            const tag = this.retagModal.newTag.trim();
            if (!tag) {
                this.retagModal.error = 'Please enter a new tag.';
                return;
            }
            this.retagModal.loading = true;
            this.retagModal.error = null;
            try {
                const response = await fetch(`/api/containers/${this.retagModal.container.name}/retag`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag: tag })
                });
                const data = await response.json();
                if (data.success) {
                    this.retagModal.show = false;
                    this.showToast(`Container "${this.retagModal.container.name}" retagged to ${data.data?.new_image || tag}`, 'success');
                    await this.loadContainers();
                    await this.loadImagesUpdateMap();
                } else {
                    this.retagModal.error = data.error || 'Retag failed';
                }
            } catch (error) {
                this.retagModal.error = error.message;
            } finally {
                this.retagModal.loading = false;
            }
        },

        /**
         * Show toast notification
         */
        showToast(message, type = 'info') {
            this.toast.message = message;
            this.toast.type = type;
            this.toast.show = true;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                this.toast.show = false;
            }, 5000);
        },
        
        /**
         * Start auto-refresh polling (every 10 seconds)
         * Educational note: Keeps UI in sync with Docker daemon state
         */
        startPolling() {
            this.pollInterval = setInterval(() => {
                // Pause polling when any modal is open, bulk operation in progress, or containers are selected
                if (!this.loading &&
                    !this.deleteModal.show &&
                    !this.detailsModal.show &&
                    !this.createModal.show &&
                    !this.bulkModal.show &&
                    !this.retagModal.show &&
                    this.selectedContainers.length === 0) {
                    this.loadContainers();
                }
            }, 10000); // 10 seconds
        },
        
        /**
         * Toggle selection of a single container
         */
        toggleSelect(containerName) {
            const index = this.selectedContainers.indexOf(containerName);
            if (index > -1) {
                this.selectedContainers.splice(index, 1);
            } else {
                this.selectedContainers.push(containerName);
            }
            // Update selectAll checkbox state
            this.selectAll = this.selectedContainers.length === this.filteredContainers.length;
        },

        /**
         * Toggle selection of all filtered containers
         */
        toggleSelectAll() {
            if (this.selectAll) {
                // Select all filtered containers (excluding external containers)
                this.selectedContainers = this.filteredContainers
                    .filter(c => c.managed !== false)  // Only managed containers
                    .map(c => c.name);
            } else {
                // Deselect all
                this.selectedContainers = [];
            }
        },

        /**
         * Show bulk operation confirmation modal
         */
        showBulkConfirmation(operation) {
            const labels = {
                'start': 'start',
                'stop': 'stop',
                'restart': 'restart',
                'delete': 'delete'
            };

            this.bulkModal.operation = operation;
            this.bulkModal.operationLabel = labels[operation];
            this.bulkModal.completed = false;
            this.bulkModal.results = [];
            this.bulkModal.show = true;
        },

        /**
         * Execute bulk operation on selected containers
         */
        async executeBulkOperation() {
            this.bulkModal.loading = true;
            this.bulkModal.results = [];

            const operation = this.bulkModal.operation;
            const endpoints = {
                'start': (name) => `/api/containers/${name}/start`,
                'stop': (name) => `/api/containers/${name}/stop`,
                'restart': (name) => `/api/containers/${name}/restart`,
                'delete': (name) => `/api/containers/${name}?force=true`  // Force delete even if running
            };

            const method = operation === 'delete' ? 'DELETE' : 'POST';

            // Process each container sequentially
            for (const containerName of this.selectedContainers) {
                try {
                    const response = await fetch(endpoints[operation](containerName), {
                        method: method
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.bulkModal.results.push({
                            container: containerName,
                            success: true,
                            message: data.message || `${operation} successful`
                        });
                    } else {
                        this.bulkModal.results.push({
                            container: containerName,
                            success: false,
                            message: data.error || data.message || `Failed to ${operation}`
                        });
                    }
                } catch (error) {
                    this.bulkModal.results.push({
                        container: containerName,
                        success: false,
                        message: error.message
                    });
                }
            }

            // Show results
            this.bulkModal.loading = false;
            this.bulkModal.completed = true;

            // Reload containers to reflect changes
            await this.loadContainers();

            // Clear selection
            this.selectedContainers = [];
            this.selectAll = false;

            // Show summary toast
            const successCount = this.bulkModal.results.filter(r => r.success).length;
            const totalCount = this.bulkModal.results.length;
            if (successCount === totalCount) {
                this.showToast(`Successfully ${this.bulkModal.operationLabel}ed ${successCount} container(s)`, 'success');
            } else if (successCount > 0) {
                this.showToast(`${successCount} of ${totalCount} operations succeeded`, 'warning');
            } else {
                this.showToast(`All operations failed`, 'error');
            }
        },

        /**
         * Close bulk operation modal
         */
        closeBulkModal() {
            this.bulkModal.show = false;
            this.bulkModal.loading = false;
            this.bulkModal.completed = false;
            this.bulkModal.results = [];
        },

        /**
         * Cleanup on component destroy
         */
        destroy() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
            }
            // TASK 7 FIX: Stop all health check polling
            this.stopAllHealthCheckPolling();
        }
    }
}
</script>
{% endblock %}