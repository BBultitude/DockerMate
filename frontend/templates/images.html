{% extends "base.html" %}
{% block title %}Images - DockerMate{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900" x-data="imagesComponent()" x-init="init()">
    {% include 'components/navbar.html' %}

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-white">Docker Images</h2>
                <p class="text-slate-400 mt-1">Manage Docker images and check for updates</p>
            </div>
            <div class="flex gap-3">
                <button @click="checkForUpdates()"
                        :disabled="loading"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400 text-white rounded-md transition">
                    üîÑ Check for Updates
                </button>
                <button @click="showPullModal = true"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition">
                    ‚¨áÔ∏è Pull Image
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <p class="text-slate-400 text-sm">Total Images</p>
                <p class="text-2xl font-bold text-white mt-1" x-text="images.length"></p>
            </div>
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <p class="text-slate-400 text-sm">Total Size</p>
                <p class="text-2xl font-bold text-white mt-1" x-text="formatTotalSize()"></p>
            </div>
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <p class="text-slate-400 text-sm">Updates Available</p>
                <p class="text-2xl font-bold text-white mt-1" x-text="updatesCount"></p>
            </div>
        </div>

        <!-- Search & Filter Bar -->
        <div x-show="!loading && images.length > 0" class="flex flex-col sm:flex-row gap-3 mb-4">
            <input type="text"
                   x-model="searchTerm"
                   placeholder="Search images‚Ä¶"
                   class="flex-1 px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:border-purple-500">
            <div class="flex gap-1">
                <button @click="imageFilter = 'all'"
                        class="px-3 py-1.5 rounded text-sm transition"
                        :class="imageFilter === 'all' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'">
                    All
                </button>
                <button @click="imageFilter = 'updates'"
                        class="px-3 py-1.5 rounded text-sm transition"
                        :class="imageFilter === 'updates' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'">
                    Updates Available
                </button>
                <button @click="imageFilter = 'dangling'"
                        class="px-3 py-1.5 rounded text-sm transition"
                        :class="imageFilter === 'dangling' ? 'bg-yellow-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'">
                    Dangling (<span x-text="images.filter(img => img.tag === '<none>').length"></span>)
                </button>
                <button @click="imageFilter = 'unused'"
                        class="px-3 py-1.5 rounded text-sm transition"
                        :class="imageFilter === 'unused' ? 'bg-red-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'">
                    Unused (<span x-text="images.filter(img => !img.in_use).length"></span>)
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            <p class="text-slate-400 mt-4">Loading images...</p>
        </div>

        <!-- Empty State (no images at all) -->
        <div x-show="!loading && images.length === 0" class="bg-slate-800 rounded-lg border border-slate-700 p-12 text-center">
            <div class="text-6xl mb-4">üñºÔ∏è</div>
            <h3 class="text-2xl font-semibold text-white mb-2">No Images Found</h3>
            <p class="text-slate-400 mb-4">Pull your first Docker image to get started</p>
            <button @click="showPullModal = true"
                    class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-md transition">
                ‚¨áÔ∏è Pull Image
            </button>
        </div>

        <!-- Empty State (filter returned nothing) -->
        <div x-show="!loading && images.length > 0 && filteredImages.length === 0" class="bg-slate-800 rounded-lg border border-slate-700 p-8 text-center">
            <p class="text-slate-400">No images match your search or filter.</p>
        </div>

        <!-- Images List -->
        <div x-show="!loading && filteredImages.length > 0" class="grid grid-cols-1 gap-4">
            <template x-for="image in filteredImages" :key="image.image_id">
                <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="flex flex-col">
                                    <h3 class="text-xl font-semibold text-white font-mono" x-text="image.full_name"></h3>
                                    <span x-show="image.tag === '<none>' && image.previous_tag"
                                          class="text-yellow-400 text-sm mt-1">
                                        (was <span x-text="image.repository + ':' + image.previous_tag"></span>)
                                    </span>
                                </div>
                                <span x-show="image.tag === '<none>'"
                                      class="px-2 py-1 bg-yellow-600 text-slate-900 rounded text-xs font-bold">
                                    DANGLING
                                </span>
                                <span x-show="image.update_available"
                                      class="px-2 py-1 bg-yellow-900 text-yellow-300 rounded text-xs font-medium">
                                    UPDATE AVAILABLE
                                </span>
                            </div>
                            <p class="text-slate-400 text-sm font-mono mb-1">
                                ID: <span x-text="image.image_id.substring(0, 12)"></span>
                            </p>
                            <p class="text-slate-500 text-xs">
                                Size: <span x-text="formatSize(image.size_bytes)"></span> |
                                Created: <span x-text="formatDate(image.created_at)"></span>
                                <span x-show="image.pulled_at"> | Pulled: <span x-text="formatDate(image.pulled_at)"></span></span>
                            </p>
                            <p class="text-slate-400 text-xs mt-1">
                                <span x-show="image.in_use" class="text-green-400">
                                    ‚úì Used by <span x-text="image.containers_using"></span> container(s)
                                </span>
                                <span x-show="!image.in_use" class="text-slate-500">
                                    ‚ö† Unused - safe to prune
                                </span>
                            </p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-2">
                        <button @click="showTagModal(image)"
                                class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition text-sm">
                            üè∑Ô∏è Tag
                        </button>
                        <button @click="confirmDelete(image)"
                                class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md transition text-sm">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Last Updated -->
        <div x-show="!loading && filteredImages.length > 0" class="mt-6 text-center">
            <p class="text-slate-500 text-sm">
                Last updated: <span x-text="lastUpdated"></span>
            </p>
        </div>
    </main>

    <!-- Pull Image Modal -->
    <div x-show="showPullModal"
             x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="showPullModal = false">
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold text-white mb-4">Pull Docker Image</h3>

            <form @submit.prevent="pullImage()">
                <div class="mb-4">
                    <label class="block text-sm text-slate-400 mb-2">Repository</label>
                    <input type="text"
                           x-model="pullForm.repository"
                           placeholder="e.g., nginx, ghcr.io/user/image, quay.io/repo/image"
                           required
                           class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white">
                    <p class="text-xs text-slate-500 mt-1">
                        üí° Supports Docker Hub, GHCR, Quay, and any registry. Use full path for non-Docker Hub registries.
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-slate-400 mb-2">Tag</label>
                    <input type="text"
                           x-model="pullForm.tag"
                           placeholder="e.g., latest, alpine, 8.0"
                           class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white">
                </div>

                <div x-show="pullForm.error" class="mb-4 p-3 bg-red-900/20 border border-red-700 rounded text-red-300 text-sm">
                    <span x-text="pullForm.error"></span>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button"
                            @click="showPullModal = false"
                            :disabled="pullForm.loading"
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition">
                        Cancel
                    </button>
                    <button type="submit"
                            :disabled="pullForm.loading"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-green-400 text-white rounded-md transition">
                        <span x-show="!pullForm.loading">‚¨áÔ∏è Pull Image</span>
                        <span x-show="pullForm.loading">‚è≥ Pulling...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tag Image Modal -->
    <div x-show="showTagModalState"
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="showTagModalState = false">
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold text-white mb-4">Tag Image</h3>

            <p class="text-slate-400 text-sm mb-4">
                Source: <span class="text-white font-mono" x-text="tagForm.sourceImage"></span>
            </p>

            <form @submit.prevent="tagImage()">
                <div class="mb-4">
                    <label class="block text-sm text-slate-400 mb-2">New Repository</label>
                    <input type="text"
                           x-model="tagForm.repository"
                           placeholder="e.g., my-nginx"
                           required
                           class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white">
                </div>

                <div class="mb-4">
                    <label class="block text-sm text-slate-400 mb-2">New Tag</label>
                    <input type="text"
                           x-model="tagForm.tag"
                           placeholder="e.g., v1.0"
                           class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-white">
                </div>

                <div x-show="tagForm.error" class="mb-4 p-3 bg-red-900/20 border border-red-700 rounded text-red-300 text-sm">
                    <span x-text="tagForm.error"></span>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button"
                            @click="showTagModalState = false"
                            :disabled="tagForm.loading"
                            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition">
                        Cancel
                    </button>
                    <button type="submit"
                            :disabled="tagForm.loading"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white rounded-md transition">
                        <span x-show="!tagForm.loading">üè∑Ô∏è Tag</span>
                        <span x-show="tagForm.loading">‚è≥ Tagging...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="deleteModal.show"
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
         @click.self="deleteModal.show = false">
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold text-white mb-4">Confirm Delete</h3>

            <p class="text-slate-300 mb-4">
                Are you sure you want to delete image <span class="font-mono text-white" x-text="deleteModal.imageName"></span>?
            </p>

            <div class="mb-4">
                <label class="flex items-center gap-2 text-sm text-slate-300 cursor-pointer">
                    <input type="checkbox" x-model="deleteModal.force" class="rounded">
                    <span>Force delete (remove even if containers are using it)</span>
                </label>
            </div>

            <div x-show="deleteModal.error" class="mb-4 p-3 bg-red-900/20 border border-red-700 rounded text-red-300 text-sm">
                <span x-text="deleteModal.error"></span>
            </div>

            <div class="flex justify-end gap-3">
                <button @click="deleteModal.show = false"
                        :disabled="deleteModal.loading"
                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-md transition">
                    Cancel
                </button>
                <button @click="deleteImage()"
                        :disabled="deleteModal.loading"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-red-400 text-white rounded-md transition">
                    <span x-show="!deleteModal.loading">üóëÔ∏è Delete</span>
                    <span x-show="deleteModal.loading">‚è≥ Deleting...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.show"
         x-transition
         class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50"
         :class="{
             'bg-green-600': toast.type === 'success',
             'bg-red-600': toast.type === 'error',
             'bg-blue-600': toast.type === 'info'
         }">
        <p class="text-white" x-text="toast.message"></p>
    </div>
</div>

<script>
function imagesComponent() {
    return {
        images: [],
        loading: false,
        lastUpdated: 'Never',
        updatesCount: 0,
        showPullModal: false,
        showTagModalState: false,
        searchTerm: '',
        imageFilter: 'all',   // 'all' | 'updates' | 'dangling' | 'unused'

        get filteredImages() {
            let list = this.images;
            if (this.imageFilter === 'updates') {
                list = list.filter(img => img.update_available);
            } else if (this.imageFilter === 'dangling') {
                list = list.filter(img => img.tag === '<none>');
            } else if (this.imageFilter === 'unused') {
                list = list.filter(img => !img.in_use);
            }
            const term = this.searchTerm.trim().toLowerCase();
            if (term) {
                list = list.filter(img =>
                    (img.full_name || '').toLowerCase().includes(term) ||
                    (img.previous_tag && img.previous_tag.toLowerCase().includes(term))
                );
            }
            // STABLE SORT by name to prevent flickering
            return list.slice().sort((a, b) => (a.full_name || '').localeCompare(b.full_name || ''));
        },

        pullForm: {
            repository: '',
            tag: 'latest',
            loading: false,
            error: ''
        },

        tagForm: {
            sourceImage: '',
            sourceId: '',
            repository: '',
            tag: 'latest',
            loading: false,
            error: ''
        },

        deleteModal: {
            show: false,
            imageId: '',
            imageName: '',
            force: false,
            loading: false,
            error: ''
        },

        toast: {
            show: false,
            message: '',
            type: 'info'
        },

        async init() {
            await this.loadImages();
            // Load usage stats in background after page renders
            this.loadUsageStats();
        },

        async loadImages() {
            this.loading = true;
            try {
                // Fast load without usage stats - show page immediately
                const response = await fetch('/api/images');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (data.success) {
                    this.images = data.data;
                    this.updatesCount = this.images.filter(img => img.update_available).length;
                    this.lastUpdated = new Date().toLocaleTimeString();
                } else {
                    this.showToast('Failed to load images: ' + data.error, 'error');
                }
            } catch (error) {
                this.showToast('Failed to load images: ' + error.message, 'error');
            } finally {
                this.loading = false;
            }
        },

        async loadUsageStats() {
            try {
                // Load usage stats in background (slower)
                const response = await fetch('/api/images?include_usage=true');
                if (!response.ok) return; // Silently fail - usage stats are optional

                const data = await response.json();
                if (data.success) {
                    // Update existing images with usage data
                    data.data.forEach(imageWithUsage => {
                        const existing = this.images.find(img => img.image_id === imageWithUsage.image_id);
                        if (existing) {
                            existing.containers_using = imageWithUsage.containers_using;
                            existing.in_use = imageWithUsage.in_use;
                        }
                    });
                }
            } catch (error) {
                console.warn('Failed to load usage stats:', error);
                // Don't show error toast - usage stats are optional enhancement
            }
        },

        async pullImage() {
            this.pullForm.loading = true;
            this.pullForm.error = '';

            try {
                const response = await fetch('/api/images/pull', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCSRFHeaders()
                    },
                    body: JSON.stringify({
                        repository: this.pullForm.repository,
                        tag: this.pullForm.tag
                    })
                });

                const data = await response.json();
                if (data.success) {
                    this.showToast('Image pulled successfully', 'success');
                    this.showPullModal = false;
                    this.pullForm.repository = '';
                    this.pullForm.tag = 'latest';
                    await this.loadImages();
                } else {
                    this.pullForm.error = data.error || 'Failed to pull image';
                }
            } catch (error) {
                this.pullForm.error = 'Failed to pull image: ' + error.message;
            } finally {
                this.pullForm.loading = false;
            }
        },

        showTagModal(image) {
            this.tagForm.sourceImage = image.full_name;
            this.tagForm.sourceId = image.full_name;
            this.tagForm.repository = '';
            this.tagForm.tag = 'latest';
            this.tagForm.error = '';
            this.showTagModalState = true;
        },

        async tagImage() {
            this.tagForm.loading = true;
            this.tagForm.error = '';

            try {
                const response = await fetch(`/api/images/${encodeURIComponent(this.tagForm.sourceId)}/tag`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getCSRFHeaders()
                    },
                    body: JSON.stringify({
                        repository: this.tagForm.repository,
                        tag: this.tagForm.tag
                    })
                });

                const data = await response.json();
                if (data.success) {
                    this.showToast('Image tagged successfully', 'success');
                    this.showTagModalState = false;
                    await this.loadImages();
                } else {
                    this.tagForm.error = data.error || 'Failed to tag image';
                }
            } catch (error) {
                this.tagForm.error = 'Failed to tag image: ' + error.message;
            } finally {
                this.tagForm.loading = false;
            }
        },

        confirmDelete(image) {
            // Use image_id (SHA256) instead of full_name for reliable deletion
            // Fixes issue with dangling images (<none>:<none>) having invalid URLs
            this.deleteModal.imageId = image.image_id;
            this.deleteModal.imageName = image.full_name;
            this.deleteModal.force = false;
            this.deleteModal.error = '';
            this.deleteModal.show = true;
        },

        async deleteImage() {
            this.deleteModal.loading = true;
            this.deleteModal.error = '';

            try {
                const params = new URLSearchParams();
                if (this.deleteModal.force) {
                    params.append('force', 'true');
                }

                const response = await fetch(`/api/images/${encodeURIComponent(this.deleteModal.imageId)}?${params}`, {
                    method: 'DELETE',
                    headers: getCSRFHeaders()
                });

                const data = await response.json();
                if (data.success) {
                    this.showToast('Image deleted successfully', 'success');
                    this.deleteModal.show = false;
                    await this.loadImages();
                } else {
                    this.deleteModal.error = data.error || 'Failed to delete image';
                }
            } catch (error) {
                this.deleteModal.error = 'Failed to delete image: ' + error.message;
            } finally {
                this.deleteModal.loading = false;
            }
        },

        async checkForUpdates() {
            this.loading = true;
            try {
                const response = await fetch('/api/images/updates');
                const data = await response.json();
                if (data.success) {
                    this.showToast(`Update check complete. ${data.count} updates available`, 'success');
                    await this.loadImages();
                } else {
                    this.showToast('Failed to check for updates', 'error');
                }
            } catch (error) {
                this.showToast('Failed to check for updates: ' + error.message, 'error');
            } finally {
                this.loading = false;
            }
        },

        formatSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        },

        formatTotalSize() {
            const total = this.images.reduce((sum, img) => sum + (img.size_bytes || 0), 0);
            return this.formatSize(total);
        },

        formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        },

        showToast(message, type = 'info') {
            this.toast.message = message;
            this.toast.type = type;
            this.toast.show = true;
            setTimeout(() => {
                this.toast.show = false;
            }, 3000);
        }
    };
}
</script>

<style>
[x-cloak] { display: none !important; }
</style>
{% endblock %}
